<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å…³é”®è¯ç»„ - OnTargetæ–‡çŒ®æ¨é€ç³»ç»Ÿ</title>
    <link rel="icon" type="image/jpeg" href="/static/images/logo.jpg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #5a9a8f;
            --primary-light: #7ab5ac;
            --primary-dark: #4a8579;
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f3f4;
            --text-primary: #2d3436;
            --text-secondary: #636e72;
            --text-muted: #b2bec3;
            --border-color: #dfe6e9;
            --border-light: #f1f3f4;
            --success: #00b894;
            --danger: #ff7675;
            --warning: #fdcb6e;
            --radius-sm: 6px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: var(--spacing-md) var(--spacing-xl);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .logo-text {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .header-nav {
            display: flex;
            gap: var(--spacing-sm);
            align-items: center;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-danger {
            background: rgba(255, 118, 117, 0.1);
            color: var(--danger);
        }

        .btn-danger:hover {
            background: rgba(255, 118, 117, 0.2);
        }

        /* Main Container */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-xl);
        }

        .page-header {
            margin-bottom: var(--spacing-xl);
        }

        .page-header h1 {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .page-header p {
            color: var(--text-secondary);
        }

        /* Action Bar */
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-xl);
            padding: var(--spacing-md);
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }



        /* Group Cards Grid */
        .groups-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: var(--spacing-lg);
        }

        /* Group Card */
        .group-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            overflow: hidden;
            transition: all 0.3s;
            cursor: pointer;
        }

        .group-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
            border-color: var(--primary);
        }

        .group-card.inactive {
            opacity: 0.5;
            background: #f5f5f5;
            border: 2px dashed #ccc;
        }

        .group-card.inactive .group-name {
            color: #999;
            text-decoration: line-through;
        }

        .group-card.inactive .group-icon {
            filter: grayscale(100%);
        }

        .group-status-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }

        .group-status-badge.active {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
        }

        .group-status-badge.inactive {
            background: rgba(108, 117, 125, 0.1);
            color: #6c757d;
        }

        .group-header {
            padding: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            border-bottom: 1px solid var(--border-light);
        }

        .group-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .group-info {
            flex: 1;
        }

        .group-name {
            font-weight: 600;
            font-size: 1rem;
        }

        .group-description {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .group-actions {
            display: flex;
            gap: var(--spacing-xs);
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .action-btn.toggle-active {
            background: var(--success);
            color: white;
        }

        .action-btn.toggle-inactive {
            background: var(--text-muted);
            color: white;
        }

        .group-content {
            padding: var(--spacing-md);
        }

        .keywords-preview {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-md);
            min-height: 32px;
        }

        .keyword-tag {
            padding: 0.25rem 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .keyword-tag.more {
            background: var(--primary);
            color: white;
        }

        .group-stats {
            display: flex;
            gap: var(--spacing-md);
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        /* Add Group Card */
        .add-group-card {
            background: var(--bg-secondary);
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-xl);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 200px;
        }

        .add-group-card:hover {
            border-color: var(--primary);
            background: rgba(90, 154, 143, 0.05);
        }

        .add-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: var(--spacing-md);
        }

        .add-text {
            font-weight: 500;
            color: var(--text-secondary);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-muted);
            cursor: pointer;
        }

        .modal-body {
            padding: var(--spacing-lg);
        }

        .modal-footer {
            padding: var(--spacing-lg);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-sm);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: var(--spacing-md);
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: var(--spacing-xs);
        }

        .form-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            transition: border-color 0.2s;
            font-family: inherit;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            background: white;
        }

        /* Icon Selector */
        .icon-selector {
            display: flex;
            gap: var(--spacing-xs);
            flex-wrap: wrap;
        }

        .icon-option {
            width: 40px;
            height: 40px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .icon-option:hover {
            border-color: var(--primary);
        }

        .icon-option.selected {
            border-color: var(--primary);
            background: rgba(90, 154, 143, 0.1);
        }

        /* Color Selector */
        .color-selector {
            display: flex;
            gap: var(--spacing-xs);
            flex-wrap: wrap;
        }

        .color-option {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: var(--text-primary);
        }

        /* Toggle Switch */
        .toggle-switch {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .toggle {
            position: relative;
            width: 48px;
            height: 24px;
            background: var(--text-muted);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle.active {
            background: var(--success);
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle.active .toggle-slider {
            transform: translateX(24px);
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-sm);
            color: white;
            font-weight: 500;
            z-index: 2000;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--danger);
        }

        .toast.info {
            background: var(--primary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: var(--spacing-md);
            display: block;
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: var(--spacing-sm) var(--spacing-md);
            }

            .header-content {
                flex-direction: row;
                flex-wrap: wrap;
                gap: var(--spacing-xs);
            }

            .logo-text {
                font-size: 1rem;
            }

            .logo-icon {
                width: 36px;
                height: 36px;
            }

            .header-nav .btn span {
                display: none;
            }

            .header-nav .btn {
                padding: 0.4rem;
                width: 36px;
                height: 36px;
                justify-content: center;
            }

            .main-container {
                padding: var(--spacing-md);
            }

            .page-header h1 {
                font-size: 1.4rem;
            }

            .page-header p {
                font-size: 0.875rem;
            }

            .action-bar {
                flex-direction: column;
                gap: var(--spacing-sm);
                align-items: stretch;
            }

            .action-bar .btn {
                width: 100%;
                justify-content: center;
            }

            .groups-grid {
                grid-template-columns: 1fr;
                gap: var(--spacing-md);
            }

            .group-card {
                border-radius: var(--radius-sm);
            }

            .group-header {
                padding: var(--spacing-sm);
            }

            .group-icon {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }

            .group-name {
                font-size: 0.9rem;
            }

            .group-description {
                font-size: 0.7rem;
            }

            .group-actions {
                gap: 0.25rem;
            }

            .action-btn {
                width: 28px;
                height: 28px;
                font-size: 0.8rem;
            }

            .group-content {
                padding: var(--spacing-sm);
            }

            .keywords-preview {
                min-height: auto;
                margin-bottom: var(--spacing-sm);
            }

            .keyword-tag {
                font-size: 0.7rem;
                padding: 0.2rem 0.4rem;
            }

            .group-stats {
                font-size: 0.75rem;
                gap: var(--spacing-sm);
            }

            .add-group-card {
                min-height: 150px;
                padding: var(--spacing-lg);
            }

            .add-icon {
                width: 48px;
                height: 48px;
                font-size: 1.25rem;
            }

            /* Modal improvements for mobile */
            .modal-content {
                width: 95%;
                max-width: none;
                max-height: 90vh;
                margin: var(--spacing-md);
                border-radius: var(--radius-md);
            }

            .modal-header {
                padding: var(--spacing-md);
            }

            .modal-title {
                font-size: 1rem;
            }

            .modal-body {
                padding: var(--spacing-md);
            }

            .modal-footer {
                padding: var(--spacing-md);
                flex-direction: column;
                gap: var(--spacing-xs);
            }

            .modal-footer .btn {
                width: 100%;
                justify-content: center;
            }

            .form-group {
                margin-bottom: var(--spacing-sm);
            }

            .form-label {
                font-size: 0.8rem;
            }

            .form-input {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 0.625rem;
            }

            .form-textarea {
                min-height: 80px;
            }

            .icon-selector {
                gap: 0.25rem;
            }

            .icon-option {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }

            .color-option {
                width: 28px;
                height: 28px;
            }

            .category-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .category-item {
                padding: 12px 8px;
            }

            .toggle-switch {
                font-size: 0.875rem;
            }

            /* Settings modal specific */
            #settings-modal .modal-content {
                max-height: 85vh;
            }

            #sources-checkboxes {
                gap: 0.375rem;
            }

            #sources-checkboxes label {
                padding: 0.25rem 0.5rem;
                font-size: 0.8rem;
            }
        }

        @media (max-width: 480px) {
            .group-stats {
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .stat-item {
                flex: 1 1 45%;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">
                    <img src="/static/images/logo.jpg" alt="Logo">
                </div>
                <div class="logo-text">OnTargetæ–‡çŒ®æ¨é€ç³»ç»Ÿ</div>
            </div>
            <nav class="header-nav">
                <a href="javascript:void(0)" class="btn btn-secondary" onclick="goToFirstGroup()">
                    <i class="fas fa-home"></i> é¦–é¡µ
                </a>
                <div class="user-info" id="user-info" style="margin-left: 0.5rem; cursor: pointer;" onclick="openSettingsModal()" title="ç”¨æˆ·è®¾ç½®">
                    <span id="user-avatar" style="font-size: 24px;">ğŸ‘¤</span>
                    <span id="user-name" style="font-size: 0.875rem;">æœ¬åœ°ç”¨æˆ·</span>
                    <i class="fas fa-cog" style="font-size: 12px; margin-left: 4px;"></i>
                </div>
            </nav>
        </div>
    </header>

    <!-- Main Container -->
    <main class="main-container">
        <!-- Page Header -->
        <div class="page-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>ç®¡ç†å…³é”®è¯ç»„</h1>
                    <p>åˆ›å»ºå’Œç®¡ç†å¤šä¸ªå…³é”®è¯ç»„ï¼Œæ¯ä¸ªç»„å¯¹åº”ä¸åŒçš„ç ”ç©¶é¢†åŸŸ</p>
                </div>

            </div>
        </div>

        <!-- Action Bar -->
        <div class="action-bar">
            <span id="groups-count" style="color: var(--text-secondary);">
                åŠ è½½ä¸­...
            </span>
            <button class="btn btn-primary" onclick="openCreateModal()">
                <i class="fas fa-plus"></i> åˆ›å»ºæ–°ç»„
            </button>
        </div>

        <!-- Groups Grid -->
        <div class="groups-grid" id="groups-container">
            <!-- Groups will be loaded dynamically -->
        </div>
    </main>

    <!-- Create/Edit Modal -->
    <div id="group-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">åˆ›å»ºå…³é”®è¯ç»„</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="group-form">
                    <input type="hidden" id="group-id">
                    
                    <div class="form-group">
                        <label class="form-label">ç»„åç§° *</label>
                        <input type="text" class="form-input" id="group-name" 
                               placeholder="ä¾‹å¦‚ï¼šè›‹ç™½é™è§£ç ”ç©¶" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">æè¿°</label>
                        <input type="text" class="form-input" id="group-description" 
                               placeholder="ç®€è¦æè¿°è¿™ä¸ªç»„çš„ç ”ç©¶æ–¹å‘">
                    </div>

                    <div class="form-group">
                        <label class="form-label">é€‰æ‹©å›¾æ ‡</label>
                        <div class="icon-selector" id="icon-selector">
                            <!-- ç§‘å­¦ç ”ç©¶ -->
                            <div class="icon-option selected" data-icon="ğŸ”¬">ğŸ”¬</div>
                            <div class="icon-option" data-icon="ğŸ§ª">ğŸ§ª</div>
                            <div class="icon-option" data-icon="ğŸ§«">ğŸ§«</div>
                            <div class="icon-option" data-icon="âš—ï¸">âš—ï¸</div>
                            <div class="icon-option" data-icon="ğŸ§¬">ğŸ§¬</div>
                            <div class="icon-option" data-icon="ğŸ”­">ğŸ”­</div>
                            <div class="icon-option" data-icon="âš›ï¸">âš›ï¸</div>
                            <div class="icon-option" data-icon="ğŸ§®">ğŸ§®</div>
                            <!-- åŒ»å­¦å¥åº· -->
                            <div class="icon-option" data-icon="ğŸ©º">ğŸ©º</div>
                            <div class="icon-option" data-icon="ğŸ’Š">ğŸ’Š</div>
                            <div class="icon-option" data-icon="ğŸ’‰">ğŸ’‰</div>
                            <div class="icon-option" data-icon="ğŸ©¹">ğŸ©¹</div>
                            <div class="icon-option" data-icon="ğŸ©¸">ğŸ©¸</div>
                            <div class="icon-option" data-icon="ğŸ§¬">ğŸ§¬</div>
                            <div class="icon-option" data-icon="ğŸ¦ ">ğŸ¦ </div>
                            <div class="icon-option" data-icon="ğŸ§«">ğŸ§«</div>
                            <!-- ç”Ÿç‰©åŒ»å­¦ -->
                            <div class="icon-option" data-icon="ğŸ§ ">ğŸ§ </div>
                            <div class="icon-option" data-icon="ğŸ«€">ğŸ«€</div>
                            <div class="icon-option" data-icon="ğŸ«">ğŸ«</div>
                            <div class="icon-option" data-icon="ğŸ¦´">ğŸ¦´</div>
                            <div class="icon-option" data-icon="ğŸ§¬">ğŸ§¬</div>
                            <div class="icon-option" data-icon="ğŸ§ª">ğŸ§ª</div>
                            <div class="icon-option" data-icon="ğŸ§«">ğŸ§«</div>
                            <div class="icon-option" data-icon="ğŸ”¬">ğŸ”¬</div>
                            <!-- æ‰©å±•ç”Ÿç‰©åŒ»å­¦ -->
                            <div class="icon-option" data-icon="ğŸ§">ğŸ§</div>
                            <div class="icon-option" data-icon="ğŸ§â€â™‚ï¸">ğŸ§â€â™‚ï¸</div>
                            <div class="icon-option" data-icon="ğŸ§â€â™€ï¸">ğŸ§â€â™€ï¸</div>
                            <div class="icon-option" data-icon="ğŸ§">ğŸ§</div>
                            <div class="icon-option" data-icon="ğŸ§â€â™‚ï¸">ğŸ§â€â™‚ï¸</div>
                            <div class="icon-option" data-icon="ğŸ§â€â™€ï¸">ğŸ§â€â™€ï¸</div>
                            <div class="icon-option" data-icon="ğŸ§˜">ğŸ§˜</div>
                            <div class="icon-option" data-icon="ğŸ§˜â€â™‚ï¸">ğŸ§˜â€â™‚ï¸</div>
                            <div class="icon-option" data-icon="ğŸ§˜â€â™€ï¸">ğŸ§˜â€â™€ï¸</div>
                            <div class="icon-option" data-icon="ğŸ›¡ï¸">ğŸ›¡ï¸</div>
                            <div class="icon-option" data-icon="ğŸ§²">ğŸ§²</div>
                            <div class="icon-option" data-icon="ğŸ”¬">ğŸ”¬</div>
                            <!-- ç»†èƒä¸åˆ†å­ -->
                            <div class="icon-option" data-icon="âš¡">âš¡</div>
                            <div class="icon-option" data-icon="ğŸ”†">ğŸ”†</div>
                            <div class="icon-option" data-icon="ğŸŒ¡ï¸">ğŸŒ¡ï¸</div>
                            <div class="icon-option" data-icon="ğŸ§¬">ğŸ§¬</div>
                            <div class="icon-option" data-icon="ğŸ”´">ğŸ”´</div>
                            <div class="icon-option" data-icon="ğŸŸ¢">ğŸŸ¢</div>
                            <div class="icon-option" data-icon="ğŸ”µ">ğŸ”µ</div>
                            <div class="icon-option" data-icon="âšª">âšª</div>
                            <!-- æ•°æ®åˆ†æ -->
                            <div class="icon-option" data-icon="ğŸ“Š">ğŸ“Š</div>
                            <div class="icon-option" data-icon="ğŸ“ˆ">ğŸ“ˆ</div>
                            <div class="icon-option" data-icon="ğŸ“‰">ğŸ“‰</div>
                            <div class="icon-option" data-icon="ğŸ“‹">ğŸ“‹</div>
                            <div class="icon-option" data-icon="ğŸ“„">ğŸ“„</div>
                            <div class="icon-option" data-icon="ğŸ“‘">ğŸ“‘</div>
                            <div class="icon-option" data-icon="ğŸ”">ğŸ”</div>
                            <div class="icon-option" data-icon="ğŸ¯">ğŸ¯</div>
                            <!-- æŠ€æœ¯å·¥ç¨‹ -->
                            <div class="icon-option" data-icon="ğŸ’»">ğŸ’»</div>
                            <div class="icon-option" data-icon="âš™ï¸">âš™ï¸</div>
                            <div class="icon-option" data-icon="ğŸ”§">ğŸ”§</div>
                            <div class="icon-option" data-icon="ğŸ”©">ğŸ”©</div>
                            <div class="icon-option" data-icon="ğŸ¤–">ğŸ¤–</div>
                            <div class="icon-option" data-icon="ğŸ’¡">ğŸ’¡</div>
                            <div class="icon-option" data-icon="ğŸ”‹">ğŸ”‹</div>
                            <div class="icon-option" data-icon="âš¡">âš¡</div>
                            <!-- è‡ªç„¶ç”Ÿæ€ -->
                            <div class="icon-option" data-icon="ğŸŒ¿">ğŸŒ¿</div>
                            <div class="icon-option" data-icon="ğŸŒ±">ğŸŒ±</div>
                            <div class="icon-option" data-icon="ğŸŒ²">ğŸŒ²</div>
                            <div class="icon-option" data-icon="ğŸŒ¾">ğŸŒ¾</div>
                            <div class="icon-option" data-icon="ğŸ„">ğŸ„</div>
                            <div class="icon-option" data-icon="ğŸŒŠ">ğŸŒŠ</div>
                            <div class="icon-option" data-icon="ğŸŒ">ğŸŒ</div>
                            <div class="icon-option" data-icon="ğŸŒ">ğŸŒ</div>
                            <!-- å­¦æœ¯æ•™è‚² -->
                            <div class="icon-option" data-icon="ğŸ“š">ğŸ“š</div>
                            <div class="icon-option" data-icon="ğŸ“–">ğŸ“–</div>
                            <div class="icon-option" data-icon="âœï¸">âœï¸</div>
                            <div class="icon-option" data-icon="ğŸ“">ğŸ“</div>
                            <div class="icon-option" data-icon="ğŸ§‘â€ğŸ“">ğŸ§‘â€ğŸ“</div>
                            <div class="icon-option" data-icon="ğŸ‘¨â€ğŸ“">ğŸ‘¨â€ğŸ“</div>
                            <div class="icon-option" data-icon="ğŸ‘©â€ğŸ“">ğŸ‘©â€ğŸ“</div>
                            <div class="icon-option" data-icon="ğŸ«">ğŸ«</div>
                            <!-- ä¸“ä¸šé¢†åŸŸ -->
                            <div class="icon-option" data-icon="âš•ï¸">âš•ï¸</div>
                            <div class="icon-option" data-icon="ğŸ¥">ğŸ¥</div>
                            <div class="icon-option" data-icon="ğŸ›ï¸">ğŸ›ï¸</div>
                            <div class="icon-option" data-icon="ğŸ¢">ğŸ¢</div>
                            <div class="icon-option" data-icon="ğŸ­">ğŸ­</div>
                            <div class="icon-option" data-icon="ğŸš‘">ğŸš‘</div>
                            <div class="icon-option" data-icon="ğŸš’">ğŸš’</div>
                            <div class="icon-option" data-icon="âœˆï¸">âœˆï¸</div>
                            <!-- é€šç”¨æ ‡å¿— -->
                            <div class="icon-option" data-icon="â­">â­</div>
                            <div class="icon-option" data-icon="ğŸŒŸ">ğŸŒŸ</div>
                            <div class="icon-option" data-icon="âœ¨">âœ¨</div>
                            <div class="icon-option" data-icon="ğŸ”¥">ğŸ”¥</div>
                            <div class="icon-option" data-icon="â„ï¸">â„ï¸</div>
                            <div class="icon-option" data-icon="ğŸŒˆ">ğŸŒˆ</div>
                            <div class="icon-option" data-icon="ğŸ’">ğŸ’</div>
                            <div class="icon-option" data-icon="ğŸ¨">ğŸ¨</div>
                            <!-- æ—¶é—´ç›¸å…³ -->
                            <div class="icon-option" data-icon="â°">â°</div>
                            <div class="icon-option" data-icon="âŒ›">âŒ›</div>
                            <div class="icon-option" data-icon="ğŸ•">ğŸ•</div>
                            <div class="icon-option" data-icon="ğŸ“…">ğŸ“…</div>
                            <div class="icon-option" data-icon="ğŸ“†">ğŸ“†</div>
                            <div class="icon-option" data-icon="ğŸ—“ï¸">ğŸ—“ï¸</div>
                            <div class="icon-option" data-icon="â±ï¸">â±ï¸</div>
                            <div class="icon-option" data-icon="ğŸ•°ï¸">ğŸ•°ï¸</div>
                            <!-- æ–‡æ¡£æ–‡ä»¶ -->
                            <div class="icon-option" data-icon="ğŸ“">ğŸ“</div>
                            <div class="icon-option" data-icon="ğŸ“‚">ğŸ“‚</div>
                            <div class="icon-option" data-icon="ğŸ—‚ï¸">ğŸ—‚ï¸</div>
                            <div class="icon-option" data-icon="ğŸ““">ğŸ““</div>
                            <div class="icon-option" data-icon="ğŸ“”">ğŸ“”</div>
                            <div class="icon-option" data-icon="ğŸ“•">ğŸ“•</div>
                            <div class="icon-option" data-icon="ğŸ“—">ğŸ“—</div>
                            <div class="icon-option" data-icon="ğŸ“˜">ğŸ“˜</div>
                            <div class="icon-option" data-icon="ğŸ“™">ğŸ“™</div>
                            <div class="icon-option" data-icon="ğŸ“’">ğŸ“’</div>
                            <div class="icon-option" data-icon="ğŸ“">ğŸ“</div>
                            <div class="icon-option" data-icon="ğŸ“Œ">ğŸ“Œ</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">é€‰æ‹©é¢œè‰²</label>
                        <div class="color-selector" id="color-selector">
                            <div class="color-option selected" style="background: #5a9a8f;" data-color="#5a9a8f"></div>
                            <div class="color-option" style="background: #e74c3c;" data-color="#e74c3c"></div>
                            <div class="color-option" style="background: #3498db;" data-color="#3498db"></div>
                            <div class="color-option" style="background: #f39c12;" data-color="#f39c12"></div>
                            <div class="color-option" style="background: #9b59b6;" data-color="#9b59b6"></div>
                            <div class="color-option" style="background: #1abc9c;" data-color="#1abc9c"></div>
                            <div class="color-option" style="background: #34495e;" data-color="#34495e"></div>
                            <div class="color-option" style="background: #e67e22;" data-color="#e67e22"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">å…³é”®è¯ *ï¼ˆæ¯è¡Œä¸€ä¸ªæˆ–é€—å·åˆ†éš”ï¼‰</label>
                        <textarea class="form-input form-textarea" id="group-keywords" 
                                  placeholder="PROTAC&#10;molecular glue&#10;E3 ligase&#10;ubiquitin-proteasome" required></textarea>
                        <small style="color: var(--text-muted);">è¾“å…¥å…³é”®è¯ï¼Œç³»ç»Ÿå°†åŒ¹é…åŒ…å«è¿™äº›å…³é”®è¯çš„æ–‡çŒ®</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">åŒ¹é…æ¨¡å¼</label>
                        <select class="form-select" id="match-mode">
                            <option value="any">åŒ…å«ä»»æ„å…³é”®è¯ï¼ˆæ¨èï¼‰</option>
                            <option value="all">å¿…é¡»åŒ…å«æ‰€æœ‰å…³é”®è¯ï¼ˆä¸¥æ ¼ï¼‰</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <div class="toggle-switch">
                            <span>å¯ç”¨è¯¥ç»„</span>
                            <div class="toggle active" id="is-active-toggle" onclick="toggleActive()">
                                <div class="toggle-slider"></div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveGroup()">
                    <i class="fas fa-save"></i> ä¿å­˜
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">ç¡®è®¤åˆ é™¤</h3>
                <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>ç¡®å®šè¦åˆ é™¤å…³é”®è¯ç»„ <strong id="delete-group-name"></strong> å—ï¼Ÿ</p>
                <p style="color: var(--danger); font-size: 0.875rem; margin-top: var(--spacing-sm);">
                    <i class="fas fa-exclamation-triangle"></i> 
                    æ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œè¯¥ç»„çš„æ‰€æœ‰æ”¶è—å’Œé˜…è¯»è®°å½•ä¹Ÿå°†è¢«åˆ é™¤ã€‚
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                    <i class="fas fa-trash"></i> åˆ é™¤
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-cog"></i> ç”¨æˆ·è®¾ç½®</h3>
                <button class="modal-close" onclick="closeSettingsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="settings-form">
                    <div class="form-group">
                        <label class="form-label">AI API ä¾›åº”å•†</label>
                        <select class="form-input" id="settings-api-provider" onchange="updateProviderInfo()">
                            <option value="deepseek">DeepSeek (æ¨è)</option>
                            <option value="openai">OpenAI</option>
                            <option value="anthropic">Anthropic Claude</option>
                            <option value="google">Google Gemini</option>
                            <option value="zhipu">æ™ºè°±AI (GLM)</option>
                            <option value="kimi">Kimi (æœˆä¹‹æš—é¢)</option>
                            <option value="doubao">è±†åŒ… (å­—èŠ‚)</option>
                            <option value="qwen">åƒé—® (é˜¿é‡Œäº‘)</option>
                            <option value="minimax">MiniMax</option>
                            <option value="tongyi">é€šä¹‰åƒé—® (é˜¿é‡Œ)</option>
                            <option value="spark">è®¯é£æ˜Ÿç«</option>
                            <option value="wenxin">æ–‡å¿ƒä¸€è¨€ (ç™¾åº¦)</option>
                            <option value="hunyuan">è…¾è®¯æ··å…ƒ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">API Key</label>
                        <input type="password" class="form-input" id="settings-api-key" 
                               placeholder="è¯·è¾“å…¥æ‚¨çš„API Key">
                        <small style="color: var(--text-muted);">ç•™ç©ºåˆ™ä½¿ç”¨ç³»ç»Ÿé»˜è®¤API</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">API Base URL (å¯é€‰)</label>
                        <input type="text" class="form-input" id="settings-api-base-url" 
                               placeholder="å¦‚ä½¿ç”¨ä»£ç†æˆ–è‡ªå®šä¹‰endpoint">
                        <small style="color: var(--text-muted);">é»˜è®¤ï¼šDeepSeek: https://api.deepseek.com | OpenAI: https://api.openai.com | Anthropic: https://api.anthropic.com</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ¨¡å‹åç§°</label>
                        <input type="text" class="form-input" id="settings-model" 
                               placeholder="å¦‚: deepseek-chat, gpt-3.5-turbo, claude-3-haiku">
                    </div>

                    <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--border-color);">

                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-database"></i> æ–‡çŒ®æ¥æº</label>
                        <div id="sources-checkboxes" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                            <!-- æ–‡çŒ®æºå¤é€‰æ¡†å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        <small style="color: var(--text-muted);">é€‰æ‹©è¦ä»å“ªäº›æ¥æºè·å–æ–‡çŒ®</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ–‡çŒ®æ›´æ–°é¢‘ç‡ (å¤©)</label>
                        <input type="number" class="form-input" id="settings-update-frequency" 
                               min="1" max="30" value="7">
                        <small style="color: var(--text-muted);">æ¯æ¬¡"æ›´æ–°æ–‡çŒ®"è·å–å¤šå°‘å¤©å†…çš„æ–‡çŒ®</small>
                    </div>

                    <!-- DEBUG: Auto Update Feature Added -->
                    <!-- è‡ªåŠ¨æ›´æ–°è®¾ç½® -->
                    <div class="form-group" style="border-top: 1px solid var(--border-color); padding-top: 1.5rem; margin-top: 1.5rem;">
                        <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="settings-auto-update-enabled" style="width: auto;">
                            <span>å¯ç”¨è‡ªåŠ¨æ›´æ–°</span>
                        </label>
                        <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">
                            ç³»ç»Ÿå°†æŒ‰è®¾å®šé—´éš”è‡ªåŠ¨è·å–æ–°æ–‡çŒ®
                        </small>
                    </div>

                    <div class="form-group" id="auto-update-interval-group" style="display: none;">
                        <label class="form-label">è‡ªåŠ¨æ›´æ–°é—´éš”</label>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button type="button" class="btn btn-sm interval-btn" data-days="2">2å¤©</button>
                            <button type="button" class="btn btn-sm interval-btn" data-days="3">3å¤©</button>
                            <button type="button" class="btn btn-sm interval-btn" data-days="7">7å¤©</button>
                            <input type="number" class="form-input" id="settings-auto-update-interval" 
                                   min="2" max="30" value="2" style="width: 80px;">
                        </div>
                        <small style="color: var(--text-muted);">æœ€å°‘2å¤©ï¼Œç³»ç»Ÿå°†é”™å³°æ‰§è¡Œé¿å…åŒæ—¶è¯·æ±‚</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">è‡ªåŠ¨åˆ†ææœ€å¤§æ•°é‡</label>
                        <input type="number" class="form-input" id="settings-max-analyze" 
                               min="1" max="50" value="20">
                        <small style="color: var(--text-muted);">è·å–æ–‡çŒ®æ—¶è‡ªåŠ¨åˆ†æçš„æœ€å¤§ç¯‡æ•°</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeSettingsModal()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveSettings()">
                    <i class="fas fa-save"></i> ä¿å­˜è®¾ç½®
                </button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <script>
        // Global state
        let groups = [];
        let selectedIcon = 'ğŸ”¬';
        let selectedColor = '#5a9a8f';
        let isActive = true;
        let deleteGroupId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadUserInfo();
            loadGroups();
            setupIconSelector();
            setupColorSelector();
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨æ‰“å¼€è®¾ç½®
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('openSettings') === '1') {
                openSettingsModal();
                // æ¸…é™¤URLå‚æ•°
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            // å½“é¡µé¢é‡æ–°å¯è§æ—¶åˆ·æ–°æ•°æ®ï¼ˆä»å…¶ä»–é¡µé¢è¿”å›æ—¶ï¼‰
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'visible') {
                    loadGroups();
                }
            });
        });

        // Load user info
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/user/me');
                const data = await response.json();
                if (data.success && data.user) {
                    document.getElementById('user-name').textContent = data.user.username;
                    if (data.user.avatar && data.user.avatar.startsWith('emoji:')) {
                        document.getElementById('user-avatar').textContent = data.user.avatar.replace('emoji:', '');
                    }
                }
            } catch (error) {
                console.error('Load user info error:', error);
            }
        }

        // Load groups
        async function loadGroups() {
            try {
                // é»˜è®¤åŠ è½½æ‰€æœ‰ç»„ï¼ˆåŒ…æ‹¬ç¦ç”¨çš„ï¼‰
                const url = '/api/user/keyword-groups?include_inactive=true';
                const response = await fetch(url);
                const contentType = response.headers.get('content-type');
                
                // æ£€æŸ¥æ˜¯å¦è¿”å›äº† HTML
                if (!contentType || !contentType.includes('application/json')) {
                    window.location.href = '/';
                    return;
                }
                
                const data = await response.json();

                if (data.success) {
                    groups = data.groups;
                    renderGroups();
                    updateGroupsCount();
                } else if (data.redirect) {
                    window.location.href = data.redirect;
                } else {
                    showToast(data.error || 'åŠ è½½å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('åŠ è½½å¤±è´¥: ' + error.message, 'error');
            }
        }

        // Render groups
        function renderGroups() {
            const container = document.getElementById('groups-container');

            if (groups.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <i class="fas fa-folder-open"></i>
                        <p>è¿˜æ²¡æœ‰å…³é”®è¯ç»„</p>
                        <button class="btn btn-primary" onclick="openCreateModal()" style="margin-top: var(--spacing-md);">
                            <i class="fas fa-plus"></i> åˆ›å»ºç¬¬ä¸€ä¸ªç»„
                        </button>
                    </div>
                `;
                return;
            }

            let html = groups.map(group => createGroupCard(group)).join('');

            // Add "Create New" card
            html += `
                <div class="add-group-card" onclick="openCreateModal()">
                    <div class="add-icon">
                        <i class="fas fa-plus"></i>
                    </div>
                    <div class="add-text">åˆ›å»ºæ–°ç»„</div>
                </div>
            `;

            container.innerHTML = html;
        }

        // Create group card HTML
        function createGroupCard(group) {
            const keywords = group.keywords || [];
            const previewKeywords = keywords.slice(0, 5);
            const hasMore = keywords.length > 5;
            const statusBadge = group.is_active 
                ? '' 
                : '<span class="group-status-badge inactive">å·²ç¦ç”¨</span>';

            return `
                <div class="group-card ${group.is_active ? '' : 'inactive'}" data-id="${group.id}" 
                     onclick="openGroupDashboard('${group.id}', event)">
                    <div class="group-header" style="background: ${group.color}10;">
                        <div class="group-icon" style="background: ${group.color}; color: white;">
                            ${group.icon}
                        </div>
                        <div class="group-info">
                            <div class="group-name">${group.name}${statusBadge}</div>
                            <div class="group-description">${group.description || 'æš‚æ— æè¿°'}</div>
                        </div>
                        <div class="group-actions" onclick="event.stopPropagation()">
                            <button class="action-btn ${group.is_active ? 'toggle-active' : 'toggle-inactive'}" 
                                    onclick="toggleGroupActive('${group.id}', ${!group.is_active}); event.stopPropagation();"
                                    title="${group.is_active ? 'ç¦ç”¨' : 'å¯ç”¨'}">
                                <i class="fas fa-power-off"></i>
                            </button>
                            <button class="action-btn" onclick="openEditModal('${group.id}'); event.stopPropagation();" title="ç¼–è¾‘">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn" onclick="openDeleteModal('${group.id}'); event.stopPropagation();" title="åˆ é™¤">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="group-content">
                        <div class="keywords-preview">
                            ${previewKeywords.map(kw => `<span class="keyword-tag">${kw}</span>`).join('')}
                            ${hasMore ? `<span class="keyword-tag more">+${keywords.length - 5}</span>` : ''}
                        </div>
                        <div class="group-stats">
                            <div class="stat-item">
                                <i class="fas fa-tag"></i>
                                <span>${keywords.length} ä¸ªå…³é”®è¯</span>
                            </div>
                            <div class="stat-item">
                                <i class="fas fa-bookmark"></i>
                                <span>${group.stats?.total_saved || 0} å·²æ”¶è—</span>
                            </div>
                            <div class="stat-item">
                                <i class="fas fa-eye"></i>
                                <span>${group.stats?.total_viewed || 0} å·²è¯»</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Update groups count
        function updateGroupsCount() {
            const activeCount = groups.filter(g => g.is_active).length;
            document.getElementById('groups-count').textContent = 
                `å…± ${groups.length} ä¸ªç»„ï¼Œ${activeCount} ä¸ªå·²å¯ç”¨`;
        }

        // Setup icon selector
        function setupIconSelector() {
            const selector = document.getElementById('icon-selector');
            selector.addEventListener('click', function(e) {
                if (e.target.classList.contains('icon-option')) {
                    selector.querySelectorAll('.icon-option').forEach(el => el.classList.remove('selected'));
                    e.target.classList.add('selected');
                    selectedIcon = e.target.dataset.icon;
                }
            });
        }

        // Setup color selector
        function setupColorSelector() {
            const selector = document.getElementById('color-selector');
            selector.addEventListener('click', function(e) {
                if (e.target.classList.contains('color-option')) {
                    selector.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
                    e.target.classList.add('selected');
                    selectedColor = e.target.dataset.color;
                }
            });
        }

        // Toggle active in modal
        function toggleActive() {
            isActive = !isActive;
            const toggle = document.getElementById('is-active-toggle');
            if (isActive) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
        }

        // Open create modal
        function openCreateModal() {
            document.getElementById('modal-title').textContent = 'åˆ›å»ºå…³é”®è¯ç»„';
            document.getElementById('group-form').reset();
            document.getElementById('group-id').value = '';
            
            // Reset selectors
            document.querySelectorAll('.icon-option').forEach(el => el.classList.remove('selected'));
            document.querySelector('.icon-option[data-icon="ğŸ”¬"]').classList.add('selected');
            selectedIcon = 'ğŸ”¬';
            
            document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
            document.querySelector('.color-option[data-color="#5a9a8f"]').classList.add('selected');
            selectedColor = '#5a9a8f';
            
            isActive = true;
            document.getElementById('is-active-toggle').classList.add('active');
            
            document.getElementById('group-modal').classList.add('active');
        }

        // Open edit modal
        function openEditModal(groupId) {
            const group = groups.find(g => g.id === groupId);
            if (!group) return;

            document.getElementById('modal-title').textContent = 'ç¼–è¾‘å…³é”®è¯ç»„';
            document.getElementById('group-id').value = group.id;
            document.getElementById('group-name').value = group.name;
            document.getElementById('group-description').value = group.description || '';
            document.getElementById('group-keywords').value = group.keywords.join('\n');
            document.getElementById('match-mode').value = group.match_mode || 'any';
            
            // Set icon
            selectedIcon = group.icon || 'ğŸ”¬';
            document.querySelectorAll('.icon-option').forEach(el => {
                el.classList.remove('selected');
                if (el.dataset.icon === selectedIcon) {
                    el.classList.add('selected');
                }
            });
            
            // Set color
            selectedColor = group.color || '#5a9a8f';
            document.querySelectorAll('.color-option').forEach(el => {
                el.classList.remove('selected');
                if (el.dataset.color === selectedColor) {
                    el.classList.add('selected');
                }
            });
            
            // Set active
            isActive = group.is_active !== false;
            const toggle = document.getElementById('is-active-toggle');
            if (isActive) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
            
            document.getElementById('group-modal').classList.add('active');
        }

        // Close modal
        function closeModal() {
            document.getElementById('group-modal').classList.remove('active');
        }

        // Save group
        async function saveGroup() {
            const groupId = document.getElementById('group-id').value;
            const name = document.getElementById('group-name').value.trim();
            const description = document.getElementById('group-description').value.trim();
            const keywordsText = document.getElementById('group-keywords').value;
            const matchMode = document.getElementById('match-mode').value;

            if (!name) {
                showToast('è¯·è¾“å…¥ç»„åç§°', 'error');
                return;
            }

            // Parse keywords
            const keywords = keywordsText.split(/[\n,]/)
                .map(k => k.trim())
                .filter(k => k.length > 0);

            if (keywords.length === 0) {
                showToast('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªå…³é”®è¯', 'error');
                return;
            }

            const groupData = {
                name: name,
                description: description,
                icon: selectedIcon,
                color: selectedColor,
                keywords: keywords,
                match_mode: matchMode,
                is_active: isActive
            };

            try {
                let response;
                if (groupId) {
                    // Update existing
                    response = await fetch(`/api/user/keyword-groups/${groupId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(groupData)
                    });
                } else {
                    // Create new
                    response = await fetch('/api/user/keyword-groups', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(groupData)
                    });
                }

                const data = await response.json();

                if (data.success) {
                    showToast(groupId ? 'æ›´æ–°æˆåŠŸ' : 'åˆ›å»ºæˆåŠŸ', 'success');
                    closeModal();
                    loadGroups();
                } else {
                    showToast(data.error || 'ä¿å­˜å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // Toggle group active
        async function toggleGroupActive(groupId, active) {
            try {
                const response = await fetch(`/api/user/keyword-groups/${groupId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: active })
                });

                const data = await response.json();

                if (data.success) {
                    showToast(active ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨', 'success');
                    loadGroups();
                } else {
                    showToast(data.error || 'æ“ä½œå¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('æ“ä½œå¤±è´¥: ' + error.message, 'error');
            }
        }

        // Open delete modal
        function openDeleteModal(groupId) {
            const group = groups.find(g => g.id === groupId);
            if (!group) return;

            deleteGroupId = groupId;
            document.getElementById('delete-group-name').textContent = group.name;
            document.getElementById('delete-modal').classList.add('active');
        }

        // Close delete modal
        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.remove('active');
            deleteGroupId = null;
        }

        // Confirm delete
        async function confirmDelete() {
            if (!deleteGroupId) return;

            try {
                const response = await fetch(`/api/user/keyword-groups/${deleteGroupId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showToast('åˆ é™¤æˆåŠŸ', 'success');
                    closeDeleteModal();
                    loadGroups();
                } else {
                    showToast(data.error || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // Toast
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Open group dashboard
        function openGroupDashboard(groupId, event) {
            // æ£€æŸ¥æ˜¯å¦æ˜¯ç‚¹å‡»äº†æ“ä½œæŒ‰é’®ï¼ˆæŒ‰é’®ä¼šé˜»æ­¢å†’æ³¡ï¼Œä½†åšä¸€ä¸ªå®‰å…¨æ£€æŸ¥ï¼‰
            if (event && event.target.closest('.action-btn')) {
                return;
            }
            
            // è·³è½¬åˆ° Dashboard å¹¶å¸¦ä¸Š group_id å‚æ•°
            window.location.href = `/?group_id=${groupId}`;
        }

        // è·³è½¬åˆ°ç¬¬ä¸€ä¸ªå…³é”®è¯ç»„
        async function goToFirstGroup() {
            try {
                const response = await fetch('/api/user/keyword-groups');
                const data = await response.json();

                if (data.success && data.groups && data.groups.length > 0) {
                    const firstGroup = data.groups[0];
                    window.location.href = `/?group_id=${firstGroup.id}`;
                } else {
                    showToast('è¯·å…ˆåˆ›å»ºå…³é”®è¯ç»„', 'info');
                }
            } catch (error) {
                console.error('Error getting first group:', error);
                window.location.href = '/';
            }
        }

        // Close modals on outside click
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }

        // Settings Modal Functions
        function openSettingsModal() {
            loadSettings();
            document.getElementById('settings-modal').classList.add('active');
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.remove('active');
        }

        async function loadSettings() {
            try {
                const response = await fetch('/api/user/settings');
                const contentType = response.headers.get('content-type');
                
                if (!contentType || !contentType.includes('application/json')) {
                    window.location.href = '/';
                    return;
                }
                
                const data = await response.json();

                if (data.success) {
                    const settings = data.settings;
                    document.getElementById('settings-api-provider').value = settings.api_provider || 'deepseek';
                    document.getElementById('settings-api-key').value = '';
                    document.getElementById('settings-api-base-url').value = settings.api_base_url || '';
                    document.getElementById('settings-model').value = settings.model || '';
                    document.getElementById('settings-update-frequency').value = settings.update_frequency_days || 7;
                    document.getElementById('settings-max-analyze').value = settings.max_auto_analyze || 20;
                    updateProviderInfo();
                    
                    // åŠ è½½æ–‡çŒ®æºé€‰é¡¹
                    loadAvailableSources(settings.sources || ['pubmed', 'biorxiv', 'medrxiv']);
                    
                    // åŠ è½½è‡ªåŠ¨æ›´æ–°è®¾ç½®
                    await loadAutoUpdateSettings();
                }
            } catch (error) {
                console.error('Load settings error:', error);
                showToast('åŠ è½½è®¾ç½®å¤±è´¥', 'error');
            }
        }

        function updateProviderInfo() {
            const provider = document.getElementById('settings-api-provider').value;
            const modelInput = document.getElementById('settings-model');
            const baseUrlInput = document.getElementById('settings-api-base-url');
            
            const providerInfo = {
                'deepseek': {'model': 'deepseek-chat', 'base': 'https://api.deepseek.com'},
                'openai': {'model': 'gpt-3.5-turbo', 'base': 'https://api.openai.com'},
                'anthropic': {'model': 'claude-3-haiku-20240307', 'base': 'https://api.anthropic.com'},
                'google': {'model': 'gemini-1.5-flash', 'base': 'https://generativelanguage.googleapis.com'},
                'zhipu': {'model': 'glm-4', 'base': 'https://open.bigmodel.cn'},
                'kimi': {'model': 'moonshot-v1-8k', 'base': 'https://api.moonshot.cn'},
                'doubao': {'model': 'doubao-lite-4k', 'base': 'https://ark.cn-beijing.volces.com'},
                'qwen': {'model': 'qwen-turbo', 'base': 'https://dashscope.aliyuncs.com'},
                'minimax': {'model': 'abab6.5s-chat', 'base': 'https://api.minimax.chat'},
                'tongyi': {'model': 'qwen-turbo', 'base': 'https://dashscope.aliyuncs.com'},
                'spark': {'model': 'Spark4.0 Ultra', 'base': 'https://spark-api.xf-yun.com'},
                'wenxin': {'model': 'ernie-4.0-8k', 'base': 'https://qianfan.baidubce.com'},
                'hunyuan': {'model': 'hunyuan', 'base': 'https://hunyuan.tencentcloudapi.com'}
            };
            
            const info = providerInfo[provider] || providerInfo['deepseek'];
            if (!modelInput.value) modelInput.placeholder = info.model;
            if (!baseUrlInput.value) baseUrlInput.placeholder = info.base;
        }

        async function loadAvailableSources(userSources) {
            try {
                const response = await fetch('/api/sources/available');
                const contentType = response.headers.get('content-type');
                
                if (!contentType || !contentType.includes('application/json')) {
                    window.location.href = '/';
                    return;
                }
                
                const data = await response.json();
                
                if (data.success) {
                    const container = document.getElementById('sources-checkboxes');
                    container.innerHTML = '';
                    
                    const sources = data.sources;
                    for (const [key, info] of Object.entries(sources)) {
                        const isChecked = userSources.includes(key);
                        const label = document.createElement('label');
                        label.style.cssText = 'display: flex; align-items: center; gap: 0.25rem; padding: 0.375rem 0.75rem; border: 1px solid var(--border-color); border-radius: 20px; cursor: pointer; font-size: 0.875rem; background: ' + (isChecked ? 'var(--primary)' : 'var(--bg-card)') + '; color: ' + (isChecked ? 'white' : 'var(--text-secondary)') + ';';
                        label.innerHTML = `
                            <input type="checkbox" value="${key}" ${isChecked ? 'checked' : ''} style="display: none;">
                            <span>${info.name}</span>
                        `;
                        label.onclick = function() {
                            const checkbox = this.querySelector('input');
                            checkbox.checked = !checkbox.checked;
                            this.style.background = checkbox.checked ? 'var(--primary)' : 'var(--bg-card)';
                            this.style.color = checkbox.checked ? 'white' : 'var(--text-secondary)';
                        };
                        container.appendChild(label);
                    }
                }
            } catch (error) {
                console.error('Load sources error:', error);
            }
        }

        // è‡ªåŠ¨æ›´æ–°è®¾ç½®ç›¸å…³å‡½æ•°
        async function loadAutoUpdateSettings() {
            try {
                const response = await fetch('/api/user/auto-update-settings');
                const data = await response.json();
                
                if (data.success) {
                    const settings = data.settings;
                    const enabled = settings.enabled || false;
                    const intervalDays = settings.interval_days || 2;
                    
                    // è®¾ç½®å¼€å…³çŠ¶æ€
                    const enabledCheckbox = document.getElementById('settings-auto-update-enabled');
                    enabledCheckbox.checked = enabled;
                    
                    // è®¾ç½®é—´éš”å¤©æ•°
                    document.getElementById('settings-auto-update-interval').value = intervalDays;
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    updateIntervalButtons(intervalDays);
                    
                    // æ˜¾ç¤º/éšè—é—´éš”è®¾ç½®
                    toggleAutoUpdateInterval(enabled);
                    
                    // ç»‘å®šå¼€å…³äº‹ä»¶
                    enabledCheckbox.onchange = function() {
                        toggleAutoUpdateInterval(this.checked);
                    };
                    
                    // ç»‘å®šé—´éš”æŒ‰é’®äº‹ä»¶
                    document.querySelectorAll('.interval-btn').forEach(btn => {
                        btn.onclick = function() {
                            const days = parseInt(this.dataset.days);
                            document.getElementById('settings-auto-update-interval').value = days;
                            updateIntervalButtons(days);
                        };
                    });
                    
                    // ç»‘å®šè¾“å…¥æ¡†äº‹ä»¶
                    document.getElementById('settings-auto-update-interval').onchange = function() {
                        let days = parseInt(this.value);
                        if (days < 2) days = 2;
                        if (days > 30) days = 30;
                        this.value = days;
                        updateIntervalButtons(days);
                    };
                }
            } catch (error) {
                console.error('åŠ è½½è‡ªåŠ¨æ›´æ–°è®¾ç½®å¤±è´¥:', error);
            }
        }
        
        function toggleAutoUpdateInterval(show) {
            const group = document.getElementById('auto-update-interval-group');
            if (group) {
                group.style.display = show ? 'block' : 'none';
            }
        }
        
        function updateIntervalButtons(selectedDays) {
            document.querySelectorAll('.interval-btn').forEach(btn => {
                const days = parseInt(btn.dataset.days);
                if (days === selectedDays) {
                    btn.classList.add('btn-primary');
                    btn.classList.remove('btn-secondary');
                } else {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-secondary');
                }
            });
        }

        async function saveSettings() {
            const apiProvider = document.getElementById('settings-api-provider').value;
            const apiKey = document.getElementById('settings-api-key').value;
            const apiBaseUrl = document.getElementById('settings-api-base-url').value;
            const model = document.getElementById('settings-model').value;
            const updateFrequency = document.getElementById('settings-update-frequency').value;
            const maxAnalyze = document.getElementById('settings-max-analyze').value;
            
            // è·å–é€‰ä¸­çš„æ–‡çŒ®æº
            const sourceCheckboxes = document.querySelectorAll('#sources-checkboxes input[type="checkbox"]');
            const selectedSources = Array.from(sourceCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);

            // è·å–è‡ªåŠ¨æ›´æ–°è®¾ç½®
            const autoUpdateEnabled = document.getElementById('settings-auto-update-enabled').checked;
            const autoUpdateInterval = parseInt(document.getElementById('settings-auto-update-interval').value) || 2;

            try {
                // ä¿å­˜å¸¸è§„è®¾ç½®
                const response = await fetch('/api/user/settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        api_provider: apiProvider,
                        api_key: apiKey,
                        api_base_url: apiBaseUrl,
                        model: model,
                        update_frequency_days: parseInt(updateFrequency),
                        max_auto_analyze: parseInt(maxAnalyze),
                        sources: selectedSources
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // ä¿å­˜è‡ªåŠ¨æ›´æ–°è®¾ç½®
                    const autoUpdateResponse = await fetch('/api/user/auto-update-settings', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            enabled: autoUpdateEnabled,
                            interval_days: Math.max(2, Math.min(30, autoUpdateInterval))
                        })
                    });

                    const autoUpdateData = await autoUpdateResponse.json();

                    if (autoUpdateData.success) {
                        showToast('è®¾ç½®å·²ä¿å­˜' + (autoUpdateEnabled ? 'ï¼Œè‡ªåŠ¨æ›´æ–°å·²å¯ç”¨' : ''), 'success');
                        closeSettingsModal();
                    } else {
                        showToast(autoUpdateData.error || 'è‡ªåŠ¨æ›´æ–°è®¾ç½®ä¿å­˜å¤±è´¥', 'error');
                    }
                } else {
                    showToast(data.error || 'ä¿å­˜å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('Save settings error:', error);
                showToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
