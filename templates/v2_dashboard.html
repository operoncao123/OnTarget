<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="version" content="20250215-2330">
    <title>OnTarget个性化文献推送 - Literature Push System</title>
    <link rel="icon" type="image/jpeg" href="/static/images/logo.jpg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #fafbf8;
            --bg-secondary: #f5f7f2;
            --bg-tertiary: #eef1ec;
            --bg-card: #ffffff;
            --primary: #5a9a8f;
            --primary-light: #7ab5ac;
            --primary-dark: #4a7f76;
            --accent-sage: #9db4a0;
            --accent-lavender: #b8a9c9;
            --accent-peach: #e8c4a8;
            --accent-sky: #a8c4d9;
            --text-primary: #4a4f48;
            --text-secondary: #6b7169;
            --text-muted: #8a9187;
            --text-light: #a8b0a3;
            --border-color: #e8ebe5;
            --border-light: #f0f2ed;
            --shadow-sm: 0 1px 3px rgba(74, 79, 72, 0.04);
            --shadow-md: 0 4px 12px rgba(74, 79, 72, 0.06);
            --shadow-lg: 0 8px 24px rgba(74, 79, 72, 0.08);
            --spacing-xs: 0.5rem;
            --spacing-sm: 1rem;
            --spacing-md: 1.5rem;
            --spacing-lg: 2rem;
            --spacing-xl: 3rem;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-full: 9999px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            font-weight: 400;
        }

        .header {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--spacing-md) var(--spacing-xl);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(90, 154, 143, 0.2);
        }

        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .logo-text {
            display: flex;
            flex-direction: column;
        }

        .logo-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .logo-subtitle {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 400;
        }

        .header-actions {
            display: flex;
            gap: var(--spacing-sm);
            align-items: center;
        }

        .btn {
            padding: 0.625rem 1.25rem;
            border: 1px solid transparent;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.25s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-family: inherit;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 8px rgba(90, 154, 143, 0.25);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(90, 154, 143, 0.35);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary);
            border-color: var(--primary-light);
            color: var(--primary);
        }

        .btn-icon {
            padding: 0.625rem;
            width: 40px;
            height: 40px;
            justify-content: center;
            border-radius: 50%;
        }

        .stats-bar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: var(--spacing-lg) var(--spacing-xl);
        }

        .stats-content {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: var(--spacing-sm);
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            padding: 0.5rem;
            background: var(--bg-card);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
            min-width: 0;
        }

        .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--border-color);
        }

        /* 已收藏统计卡片禁用hover效果 */
        .stat-item[style*="cursor: default"]:hover {
            transform: none;
            box-shadow: var(--shadow-sm);
            border-color: var(--border-light);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
            line-height: 1.2;
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-weight: 500;
            margin-top: 0.125rem;
        }

        #last-update-time {
            font-size: 1rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--spacing-xl);
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: var(--spacing-xl);
        }

        .sidebar {
            position: sticky;
            top: 100px;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }

        .sidebar::-webkit-scrollbar {
            width: 4px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        .panel {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            box-shadow: var(--shadow-sm);
        }

        .panel-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--border-light);
        }

        .panel-icon {
            width: 32px;
            height: 32px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            color: var(--primary);
        }

        .panel-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .filter-group {
            margin-bottom: var(--spacing-md);
        }

        .filter-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: var(--spacing-xs);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        .filter-options {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .filter-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-size: 0.875rem;
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }

        .filter-option:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .filter-option input[type="radio"] {
            display: none;
        }

        .filter-option.active {
            background: rgba(90, 154, 143, 0.1);
            color: var(--primary);
            font-weight: 500;
        }

        .filter-option .radio-dot {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .filter-option.active .radio-dot {
            border-color: var(--primary);
            background: var(--primary);
        }

        .filter-option.active .radio-dot::after {
            content: '';
            width: 5px;
            height: 5px;
            background: white;
            border-radius: 50%;
        }

        .slider-container {
            padding: var(--spacing-xs) 0;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--spacing-xs);
            font-size: 0.875rem;
        }

        .slider-value {
            color: var(--primary);
            font-weight: 600;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(90, 154, 143, 0.3);
            transition: all 0.2s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(90, 154, 143, 0.4);
        }

        .papers-container {
            min-height: 600px;
        }

        .papers-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
        }

        .papers-count {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .papers-count h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .papers-count .count {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
            background: rgba(90, 154, 143, 0.1);
            padding: 0.25rem 0.875rem;
            border-radius: 20px;
        }

        .sort-select {
            padding: 0.625rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sort-select:hover {
            border-color: var(--primary-light);
        }

        .sort-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .paper-card {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
            position: relative;
        }

        .paper-card:hover {
            box-shadow: var(--shadow-md);
            border-color: var(--border-color);
            transform: translateY(-2px);
        }

        .paper-card.saved {
            border-left: 4px solid var(--primary);
        }

        .paper-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .paper-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.5;
            flex: 1;
        }

        .paper-badges {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .badge {
            padding: 0.375rem 0.875rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-review {
            background: rgba(232, 196, 168, 0.25);
            color: #a67c52;
        }

        .badge-research {
            background: rgba(168, 196, 217, 0.25);
            color: #5a7a91;
        }

        .badge-score {
            background: rgba(90, 154, 143, 0.1);
            color: var(--primary);
            border: 1px solid rgba(90, 154, 143, 0.2);
        }

        .badge-if {
            background: rgba(184, 169, 201, 0.2);
            color: #7a6a8a;
        }

        .badge-saved {
            background: var(--primary);
            color: white;
        }

        .paper-meta {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            flex-wrap: wrap;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .paper-meta span {
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .paper-meta i {
            color: var(--text-light);
            width: 16px;
        }

        .paper-abstract {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-md);
            line-height: 1.7;
        }

        .paper-abstract strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .paper-abstract-cn {
            background: linear-gradient(135deg, rgba(90, 154, 143, 0.05), rgba(157, 180, 160, 0.05));
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
            border-left: 3px solid var(--primary-light);
        }

        .paper-abstract-cn-label {
            font-size: 0.75rem;
            color: var(--primary);
            margin-bottom: var(--spacing-xs);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .keyword-matches {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: var(--spacing-md);
        }

        .keyword-tag {
            padding: 0.375rem 0.75rem;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
            display: inline-flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            max-width: 100%;
            overflow-wrap: break-word;
            word-wrap: break-word;
            word-break: break-all;
            margin: 0.125rem;
        }

        .keyword-tag:hover {
            background: rgba(90, 154, 143, 0.1);
            border-color: var(--primary-light);
            color: var(--primary);
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
        }

        .analysis-section {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            border: 1px solid var(--border-light);
        }

        .analysis-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .analysis-title i {
            color: var(--primary);
            width: 16px;
        }

        .analysis-content {
            font-size: 0.875rem;
            line-height: 1.7;
            color: var(--text-secondary);
            word-break: break-word;
            overflow-wrap: break-word;
        }

        .paper-actions {
            display: flex;
            gap: var(--spacing-sm);
            align-items: center;
            margin-top: var(--spacing-md);
            padding-top: var(--spacing-md);
            border-top: 1px solid var(--border-light);
        }

        .paper-link {
            color: var(--primary);
            text-decoration: none;
            font-size: 0.875rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border-radius: 20px;
            border: 1px solid var(--border-color);
            transition: all 0.25s ease;
        }

        .paper-link:hover {
            background: rgba(90, 154, 143, 0.1);
            border-color: var(--primary-light);
            color: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-analyze {
            padding: 0.5rem 1rem;
            border: 1px solid var(--primary);
            background: rgba(90, 154, 143, 0.1);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.25s ease;
            color: var(--primary);
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
        }

        .btn-analyze:hover {
            background: var(--primary);
            color: white;
        }

        .btn-save {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.25s ease;
            color: var(--text-secondary);
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
        }

        .btn-save:hover {
            background: var(--bg-tertiary);
            color: var(--primary);
            border-color: var(--primary-light);
        }

        .btn-save.saved {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .btn-save:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-save.saved:hover {
            background: var(--primary-dark);
        }

        .loading {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--text-muted);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--bg-tertiary);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--spacing-md);
        }
        
        .loading-more {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-lg);
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        
        .loading-more i {
            font-size: 1.2rem;
        }
        
        .load-more-trigger {
            text-align: center;
            padding: var(--spacing-lg);
            color: var(--text-muted);
            font-size: 0.85rem;
            border-top: 1px dashed var(--border-color);
            margin-top: var(--spacing-md);
        }
        
        .all-loaded {
            text-align: center;
            padding: var(--spacing-lg);
            color: var(--text-muted);
            font-size: 0.85rem;
            opacity: 0.7;
        }
        
        .all-loaded i {
            color: var(--success);
            margin-right: var(--spacing-xs);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: var(--spacing-md);
            opacity: 0.4;
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-md) var(--spacing-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.success {
            border-left: 4px solid var(--primary);
        }

        .toast.error {
            border-left: 4px solid #e8a8a8;
        }

        .toast.info {
            border-left: 4px solid var(--accent-sky);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: rgba(90, 154, 143, 0.1);
            border-radius: 20px;
            font-size: 0.875rem;
            color: var(--primary);
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }

        .user-info:hover {
            background: rgba(90, 154, 143, 0.2);
        }

        .user-info i {
            font-size: 1.25rem;
        }

        /* 用户下拉菜单 */
        .user-dropdown {
            position: absolute;
            top: calc(100% + 0.5rem);
            right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 160px;
            z-index: 1000;
            display: none;
            overflow: hidden;
        }

        .user-dropdown.show {
            display: block;
        }

        .user-dropdown-item {
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background 0.2s;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 0.875rem;
        }

        .user-dropdown-item:hover {
            background: var(--bg-light);
        }

        .user-dropdown-item i {
            font-size: 1rem;
            color: var(--text-secondary);
        }

        .user-dropdown-divider {
            height: 1px;
            background: var(--border-color);
            margin: 0.25rem 0;
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-md);
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .modal-body {
            padding: var(--spacing-lg);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-sm);
            padding: var(--spacing-md) var(--spacing-lg);
            border-top: 1px solid var(--border-color);
        }

        .form-group {
            margin-bottom: var(--spacing-md);
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .input-wrapper {
            position: relative;
        }

        .input-wrapper i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            font-size: 1rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            transition: all 0.2s;
            background: var(--bg-primary);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(90, 154, 143, 0.1);
        }

        .form-input::placeholder {
            color: var(--text-light);
        }

        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .btn-secondary:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: relative;
                top: 0;
            }

            .stats-content {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Mobile Navigation */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 1px solid var(--border-color);
            z-index: 1000;
            padding: var(--spacing-xs) 0;
        }

        .mobile-nav-items {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            padding: 0.5rem;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.7rem;
            transition: all 0.2s;
            min-width: 60px;
        }

        .mobile-nav-item i {
            font-size: 1.25rem;
        }

        .mobile-nav-item.active,
        .mobile-nav-item:hover {
            color: var(--primary);
        }

        /* Mobile Sidebar Overlay */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 99;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* Mobile User Menu */
        .mobile-user-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1500;
        }

        .mobile-user-overlay.active {
            display: block;
        }

        .mobile-user-menu {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            z-index: 1501;
            max-height: 70vh;
            overflow-y: auto;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            animation: slideUp 0.3s ease;
        }

        .mobile-user-menu.active {
            display: block;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        .mobile-user-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .mobile-user-menu-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
        }

        .mobile-user-menu-close {
            background: none;
            border: none;
            font-size: 1.25rem;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.5rem;
        }

        .mobile-user-menu-items {
            padding: 0.5rem 0;
        }

        .mobile-user-menu-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            font-size: 1rem;
            color: var(--text-primary);
            cursor: pointer;
            transition: background 0.2s;
        }

        .mobile-user-menu-item:hover {
            background: var(--bg-light);
        }

        .mobile-user-menu-item i {
            font-size: 1.25rem;
            color: var(--text-secondary);
            width: 24px;
        }

        .mobile-user-menu-divider {
            height: 1px;
            background: var(--border-color);
            margin: 0.5rem 1.5rem;
        }

        @media (max-width: 768px) {
            body {
                padding-bottom: 70px;
            }

            .header-content {
                flex-direction: column;
                gap: var(--spacing-sm);
                padding: var(--spacing-sm) var(--spacing-md);
            }

            .logo-icon {
                width: 36px;
                height: 36px;
            }

            .logo-title {
                font-size: 0.9rem;
            }

            .logo-subtitle {
                display: none;
            }

            .header-actions {
                display: flex;
                width: 100%;
                justify-content: space-between;
                padding: var(--spacing-sm) 0 0;
                border-top: 1px solid var(--border-color);
                flex-wrap: nowrap;
                gap: 6px;
            }

            .header-actions .btn {
                padding: 0.4rem 0.6rem;
                height: 36px;
                font-size: 0.75rem;
                flex: 1;
                min-width: 0;
                white-space: nowrap;
            }

            .header-actions .btn span {
                display: inline;
                font-size: 0.7rem;
            }

            .hide-on-mobile {
                display: none !important;
            }

            .header-actions .btn i {
                font-size: 0.85rem;
            }

            .user-info {
                margin-left: 0;
                padding: 0.4rem;
                background: rgba(90, 154, 143, 0.1);
                border-radius: 8px;
            }

            .user-info #user-avatar {
                font-size: 18px;
            }

            #username-display {
                display: none;
            }

            .btn-icon {
                width: 36px;
                height: 36px;
                padding: 0;
                flex-shrink: 0;
            }

            .stats-bar {
                padding: var(--spacing-md);
                overflow-x: visible;
                -webkit-overflow-scrolling: touch;
            }

            .stats-content {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: var(--spacing-sm);
                min-width: auto;
            }

            .stat-item {
                padding: var(--spacing-sm);
            }

            .stat-value {
                font-size: 1.1rem;
            }
            
            #last-update-time {
                font-size: 0.85rem;
            }

            .stat-label {
                font-size: 0.65rem;
            }

            .main-container {
                grid-template-columns: 1fr;
                padding: var(--spacing-md);
                gap: var(--spacing-md);
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: -280px;
                width: 280px;
                height: 100vh;
                background: var(--bg-card);
                z-index: 100;
                transition: left 0.3s ease;
                overflow-y: auto;
                border-radius: 0;
                margin-bottom: 0;
            }

            .sidebar.active {
                left: 0;
                box-shadow: 2px 0 12px rgba(0,0,0,0.15);
            }

            .papers-header {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--spacing-sm);
            }

            .papers-count h2 {
                font-size: 1.1rem;
            }

            .papers-count .count {
                font-size: 1.25rem;
                padding: 0.2rem 0.6rem;
            }

            .sort-select {
                width: 100%;
                font-size: 0.875rem;
            }

            .paper-card {
                padding: var(--spacing-md);
                margin-bottom: var(--spacing-sm);
            }

            .paper-header {
                flex-direction: column;
                gap: var(--spacing-sm);
            }

            .paper-title {
                font-size: 1rem;
                line-height: 1.4;
            }

            .paper-badges {
                flex-wrap: wrap;
                gap: 0.375rem;
            }

            .badge {
                font-size: 0.7rem;
                padding: 0.25rem 0.6rem;
            }

            .paper-meta {
                font-size: 0.8rem;
                gap: var(--spacing-sm);
            }

            .paper-abstract {
                font-size: 0.875rem;
                line-height: 1.6;
            }

            .paper-abstract-cn {
                padding: var(--spacing-sm);
            }

            .paper-actions {
                flex-wrap: wrap;
                gap: var(--spacing-xs);
            }

            .paper-link,
            .btn-analyze,
            .btn-save {
                font-size: 0.8rem;
                padding: 0.4rem 0.75rem;
                flex: 1;
                min-width: 100px;
                justify-content: center;
            }

            .analysis-grid {
                grid-template-columns: 1fr;
                gap: var(--spacing-sm);
            }

            .analysis-section {
                padding: var(--spacing-sm);
            }

            .analysis-title {
                font-size: 0.8rem;
            }

            .analysis-content {
                font-size: 0.8rem;
                word-break: break-word;
                overflow-wrap: break-word;
            }

            .mobile-nav {
                display: block;
            }

            .toast {
                left: var(--spacing-md);
                right: var(--spacing-md);
                bottom: 80px;
                transform: translateY(100px);
            }

            .toast.show {
                transform: translateY(0);
            }
        }

        @media (max-width: 480px) {
            .header-content {
                padding: 8px 12px;
            }

            .logo-title {
                font-size: 0.85rem;
            }

            .header-actions {
                gap: 4px;
            }

            .header-actions .btn {
                padding: 0.3rem 0.4rem;
                height: 32px;
                font-size: 0.7rem;
            }

            .header-actions .btn span {
                font-size: 0.65rem;
            }

            .header-actions .btn i {
                font-size: 0.8rem;
                margin-right: 2px;
            }

            .user-info {
                padding: 0.3rem 0.4rem;
                height: 32px;
            }

            #user-avatar {
                font-size: 14px !important;
            }

            .btn-icon {
                width: 32px;
                height: 32px;
            }

            .stats-content {
                grid-template-columns: repeat(3, 1fr);
                gap: var(--spacing-xs);
            }

            .stat-value {
                font-size: 1rem;
            }
            
            #last-update-time {
                font-size: 0.85rem;
            }

            .stat-label {
                font-size: 0.6rem;
            }

            .paper-actions {
                flex-direction: column;
            }

            .paper-link,
            .btn-analyze,
            .btn-save {
                width: 100%;
            }
        }

        @media (max-width: 375px) {
            .header-actions .btn span {
                display: none;
            }

            .header-actions .btn {
                width: 36px;
                padding: 0;
                justify-content: center;
            }

            .header-actions .btn i {
                margin: 0;
                font-size: 0.9rem;
            }

            .user-info {
                width: 36px;
                padding: 0;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">
                    <img src="/static/images/logo.jpg" alt="Logo">
                </div>
                <div class="logo-text">
                    <div class="logo-title">OnTarget文献推送系统</div>
                    <div class="logo-subtitle">个性化智能推送平台</div>
                </div>
            </div>
            <div class="header-actions" id="header-actions">
                <a href="/keywords" class="btn btn-secondary">
                    <i class="fas fa-tags"></i>
                    <span>编辑关键词</span>
                </a>
                <button class="btn btn-secondary analyze-btn" onclick="analyzePending()">
                    <i class="fas fa-brain"></i>
                    <span>全部分析</span>
                </button>
                <button class="btn btn-primary update-btn" onclick="triggerUpdate()">
                    <i class="fas fa-sync-alt"></i>
                     <span>更新文献</span>
                 </button>
                 <div class="user-info" id="user-info" style="margin-left: 0.5rem;" onclick="openUserSettings(event)" title="用户设置">
                     <span id="user-avatar" style="font-size: 20px;"></span>
                     <span id="username-display">本地用户</span>
                     <i class="fas fa-cog" style="font-size: 12px; margin-left: 4px;"></i>
                 </div>
            </div>
        </div>
    </header>

    <div class="stats-bar">
        <div class="stats-content">
            <div class="stat-item">
                <span class="stat-value" id="system-papers">-</span>
                <span class="stat-label">系统文献</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="user-viewed">-</span>
                <span class="stat-label">已浏览</span>
            </div>
            <div class="stat-item" style="cursor: default;">
                <span class="stat-value" id="user-saved">-</span>
                <span class="stat-label">已收藏</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="user-keywords">-</span>
                <span class="stat-label">关键词数</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="matched-papers">-</span>
                <span class="stat-label">匹配文献</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="last-update-time">-</span>
                <span class="stat-label">最后更新</span>
            </div>
            <!-- DEBUG: Auto Update Feature Added -->
        </div>
    </div>

    <div class="main-container">
        <aside class="sidebar">
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-icon">
                        <i class="fas fa-filter"></i>
                    </div>
                    <div class="panel-title">筛选文献</div>
                </div>

                <div class="filter-group">
                    <div class="filter-label">
                        <i class="fas fa-star"></i>
                        个性化评分
                    </div>
                    <div class="slider-container">
                        <div class="slider-label">
                            <span>评分范围</span>
                            <span class="slider-value" id="score-display">0-100分</span>
                        </div>
                        <input type="range" id="min-score" min="0" max="100" step="5" value="0" oninput="updateScoreValue(this.value)">
                        <div class="slider-label" style="margin-top: 0.25rem; font-size: 0.75rem; color: var(--text-muted);">
                            <span>0分</span>
                            <span>100分</span>
                        </div>
                    </div>
                </div>

                <div class="filter-group" id="saved-status-filter">
                    <div class="filter-label">
                        <i class="fas fa-bookmark"></i>
                        收藏状态
                    </div>
                    <div class="filter-options">
                        <div class="filter-option active" data-value="all" onclick="toggleSavedStatus(this)">
                            <span class="radio-dot"></span>
                            <span>全部文献</span>
                        </div>
                        <div class="filter-option" data-value="saved" onclick="toggleSavedStatus(this)">
                            <span class="radio-dot"></span>
                            <span>仅收藏</span>
                        </div>
                    </div>
                </div>

                <div class="filter-group">
                    <div class="filter-label">
                        <i class="fas fa-file-alt"></i>
                        文献类型
                    </div>
                    <div class="filter-options" id="paper-type-filter">
                        <div class="filter-option active" data-value="" onclick="togglePaperType(this)">
                            <span class="radio-dot"></span>
                            <span>全部类型</span>
                        </div>
                        <div class="filter-option" data-value="research" onclick="togglePaperType(this)">
                            <span class="radio-dot"></span>
                            <span>研究论文</span>
                        </div>
                        <div class="filter-option" data-value="review" onclick="togglePaperType(this)">
                            <span class="radio-dot"></span>
                            <span>综述</span>
                        </div>
                    </div>
                </div>

                <div class="filter-group">
                    <div class="filter-label">
                        <i class="fas fa-sort"></i>
                        排序方式
                    </div>
                    <select id="sort-select" onchange="sortPapers()" style="width: 100%; padding: 0.5rem; border-radius: 8px; border: 1px solid var(--border-color);">
                        <option value="personalized">按个性化评分</option>
                        <option value="date">按发表日期</option>
                        <option value="if">按影响因子</option>
                    </select>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <div class="panel-icon" style="color: #7ab5ac;">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="panel-title">我的关键词</div>
                </div>
                <div id="user-keywords-list" style="font-size: 0.875rem; color: var(--text-secondary); display: flex; flex-wrap: wrap; gap: 0.25rem;">
                    加载中...
                </div>
                <div style="margin-top: 0.75rem;">
                    <a href="/keywords" class="btn btn-secondary" style="width: 100%; justify-content: center;">
                        <i class="fas fa-edit"></i>
                        编辑关键词
                    </a>
                </div>
            </div>
        </aside>

        <main class="papers-container">
            <div class="papers-header">
                <div class="papers-count">
                    <h2>个性化文献推送</h2>
                    <span class="count" id="papers-count">0</span>
                </div>
            </div>

            <div id="papers-list">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>正在加载文献数据...</p>
                </div>
            </div>
        </main>
    </div>

    <div class="toast" id="toast">
        <i class="fas fa-check-circle" style="font-size: 1.25rem;"></i>
        <span id="toast-message">操作成功</span>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settings-modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-cog"></i> 用户设置</h3>
                <button class="modal-close" onclick="closeSettingsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="settings-form">
                    <div class="form-group">
                        <label class="form-label">AI API 供应商</label>
                        <select class="form-input" id="settings-api-provider">
                            <option value="deepseek">DeepSeek (推荐)</option>
                            <option value="openai">OpenAI</option>
                            <option value="anthropic">Anthropic Claude</option>
                            <option value="google">Google Gemini</option>
                            <option value="zhipu">智谱AI (GLM)</option>
                            <option value="kimi">Kimi (月之暗面)</option>
                            <option value="doubao">豆包 (字节)</option>
                            <option value="qwen">千问 (阿里云)</option>
                            <option value="minimax">MiniMax</option>
                            <option value="tongyi">通义千问 (阿里)</option>
                            <option value="spark">讯飞星火</option>
                            <option value="wenxin">文心一言 (百度)</option>
                            <option value="hunyuan">腾讯混元</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">API Key</label>
                        <input type="password" class="form-input" id="settings-api-key" 
                               placeholder="请输入您的API Key">
                        <small style="color: var(--text-muted); font-size: 0.75rem;">留空则使用系统默认API</small>
                    </div>

                    <hr style="margin: 1rem 0; border: none; border-top: 1px solid var(--border-color);">

                    <div class="form-group">
                        <label class="form-label"><i class="fas fa-database"></i> 文献来源</label>
                        <div id="sources-checkboxes" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 12px; cursor: pointer; font-size: 0.8rem;">
                                <input type="checkbox" value="pubmed" checked> PubMed
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 12px; cursor: pointer; font-size: 0.8rem;">
                                <input type="checkbox" value="biorxiv" checked> bioRxiv
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 12px; cursor: pointer; font-size: 0.8rem;">
                                <input type="checkbox" value="medrxiv" checked> medRxiv
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.5rem; border: 1px solid var(--border-color); border-radius: 12px; cursor: pointer; font-size: 0.8rem;">
                                <input type="checkbox" value="arxiv"> arXiv
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">文献更新频率 (天)</label>
                        <input type="number" class="form-input" id="settings-update-frequency" 
                               min="1" max="30" value="7" style="width: 100px;">
                        <small style="color: var(--text-muted); font-size: 0.75rem;">每次更新获取多少天内的文献</small>
                    </div>

                    <!-- 自动更新设置 -->
                    <div class="form-group" style="border-top: 1px solid var(--border-color); padding-top: 1rem; margin-top: 1rem;">
                        <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="settings-auto-update-enabled" style="width: auto;">
                            <span>启用自动更新</span>
                        </label>
                        <small style="color: var(--text-muted); font-size: 0.75rem; display: block; margin-top: 0.25rem;">
                            系统将按设定间隔自动获取新文献
                        </small>
                    </div>

                    <div class="form-group" id="auto-update-interval-group" style="display: none;">
                        <label class="form-label">自动更新间隔</label>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                            <button type="button" class="btn btn-sm interval-btn" data-days="2" style="padding: 0.25rem 0.75rem; font-size: 0.8rem;">2天</button>
                            <button type="button" class="btn btn-sm interval-btn" data-days="3" style="padding: 0.25rem 0.75rem; font-size: 0.8rem;">3天</button>
                            <button type="button" class="btn btn-sm interval-btn" data-days="7" style="padding: 0.25rem 0.75rem; font-size: 0.8rem;">7天</button>
                            <input type="number" class="form-input" id="settings-auto-update-interval" 
                                   min="2" max="30" value="2" style="width: 70px; padding: 0.25rem;">
                        </div>
                        <small style="color: var(--text-muted); font-size: 0.75rem;">最少2天，系统将错峰执行</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">自动分析最大数量</label>
                        <input type="number" class="form-input" id="settings-max-analyze" 
                               min="1" max="50" value="20" style="width: 100px;">
                        <small style="color: var(--text-muted); font-size: 0.75rem;">获取文献时自动分析的最大篇数</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeSettingsModal()">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveSettings()">
                    <i class="fas fa-save"></i> 保存设置
                </button>
            </div>
        </div>
    </div>

    <!-- Mobile Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav">
        <div class="mobile-nav-items">
            <a href="javascript:void(0)" class="mobile-nav-item active" onclick="goToFirstGroup()">
                <i class="fas fa-home"></i>
                <span>首页</span>
            </a>
            <a href="/keywords" class="mobile-nav-item">
                <i class="fas fa-tags"></i>
                <span>关键词</span>
            </a>
            <a href="javascript:void(0)" class="mobile-nav-item" onclick="triggerUpdate()">
                <i class="fas fa-sync-alt"></i>
                <span>更新</span>
            </a>
            <a href="javascript:void(0)" class="mobile-nav-item" onclick="toggleSidebar()">
                <i class="fas fa-filter"></i>
                <span>筛选</span>
            </a>
            <a href="javascript:void(0)" class="mobile-nav-item" onclick="toggleMobileUserMenu()">
                <i class="fas fa-user"></i>
                <span>我的</span>
            </a>
        </div>
    </nav>

    <!-- Mobile User Menu (底部弹出) -->
    <div class="mobile-user-overlay" id="mobile-user-overlay" onclick="closeMobileUserMenu()"></div>
    <div class="mobile-user-menu" id="mobile-user-menu">
        <div class="mobile-user-menu-header">
            <div class="mobile-user-menu-title">
                <span id="mobile-user-avatar" style="font-size: 24px; margin-right: 8px;"></span>
                <span id="mobile-username">用户</span>
            </div>
            <button class="mobile-user-menu-close" onclick="closeMobileUserMenu()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="mobile-user-menu-items">
            <button class="mobile-user-menu-item" onclick="openUserSettings(); closeMobileUserMenu();">
                <i class="fas fa-cog"></i>
                <span>用户设置</span>
            </button>
        </div>
    </div>

    <script>
        // ============================================
        // 收藏状态管理器 - V2.5 优雅实现
        // ============================================
        class FavoriteManager {
            constructor() {
                // 所有已收藏文献的哈希集合（跨所有组）
                this.globalSavedHashes = new Set();
                // 当前组已收藏文献的哈希集合
                this.currentGroupHashes = new Set();
                // 文献到组的映射 {paper_hash: [group_ids]}
                this.paperToGroups = new Map();
                // 防止重复点击的锁
                this.isSaving = new Map();
            }

            // 初始化收藏状态
            initialize(globalSavedList, currentGroupSavedList) {
                this.globalSavedHashes.clear();
                this.currentGroupHashes.clear();
                this.paperToGroups.clear();

                // 填充全局收藏
                if (globalSavedList && Array.isArray(globalSavedList)) {
                    globalSavedList.forEach(hash => this.globalSavedHashes.add(hash));
                }

                // 填充当前组收藏
                if (currentGroupSavedList && Array.isArray(currentGroupSavedList)) {
                    currentGroupSavedList.forEach(hash => this.currentGroupHashes.add(hash));
                }

                console.log('[收藏管理器] 初始化完成:', {
                    global: this.globalSavedHashes.size,
                    currentGroup: this.currentGroupHashes.size
                });
            }

            // 添加收藏
            addFavorite(paperHash, groupId) {
                // 添加到全局收藏
                this.globalSavedHashes.add(paperHash);
                // 添加到当前组
                this.currentGroupHashes.add(paperHash);
                // 更新组映射
                if (!this.paperToGroups.has(paperHash)) {
                    this.paperToGroups.set(paperHash, []);
                }
                const groups = this.paperToGroups.get(paperHash);
                if (!groups.includes(groupId)) {
                    groups.push(groupId);
                }
            }

            // 移除收藏
            removeFavorite(paperHash, groupId) {
                // 从当前组移除
                this.currentGroupHashes.delete(paperHash);
                // 更新组映射
                if (this.paperToGroups.has(paperHash)) {
                    const groups = this.paperToGroups.get(paperHash).filter(g => g !== groupId);
                    if (groups.length === 0) {
                        // 如果该文献不再属于任何组，从全局移除
                        this.globalSavedHashes.delete(paperHash);
                        this.paperToGroups.delete(paperHash);
                    } else {
                        this.paperToGroups.set(paperHash, groups);
                    }
                }
            }

            // 检查文献是否已收藏（在当前组）
            isSavedInCurrentGroup(paperHash) {
                return this.currentGroupHashes.has(paperHash);
            }

            // 检查文献是否已收藏（全局）
            isSavedGlobally(paperHash) {
                return this.globalSavedHashes.has(paperHash);
            }

            // 获取当前组收藏数量
            getCurrentGroupCount() {
                return this.currentGroupHashes.size;
            }

            // 获取全局收藏数量
            getGlobalCount() {
                return this.globalSavedHashes.size;
            }

            // 获取收藏该文献的所有组
            getGroupsForPaper(paperHash) {
                return this.paperToGroups.get(paperHash) || [];
            }

            // 锁定文献（防止重复点击）
            lock(paperHash) {
                if (this.isSaving.has(paperHash)) {
                    return false;
                }
                this.isSaving.set(paperHash, true);
                return true;
            }

            // 解锁文献
            unlock(paperHash) {
                this.isSaving.delete(paperHash);
            }

            // 筛选仅收藏的文献
            filterSavedOnly(papers) {
                return papers.filter(p => this.globalSavedHashes.has(p.hash));
            }
        }

        // 创建全局收藏管理器实例
        const favoriteManager = new FavoriteManager();

        // ============================================
        // HTML转义函数（防止XSS攻击）
        // ============================================
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================
        // 原有变量
        // ============================================
        let allPapers = [];
        let filteredPapers = [];
        let currentUser = null;
        let currentGroup = null;
        
        // ============================================
        // 分页相关变量 (V2.6 滚动加载)
        // ============================================
        let currentPage = 1;
        let totalPages = 1;
        let totalPapers = 0;
        let isLoading = false;
        let hasMore = true;
        const PER_PAGE = 20;

        document.addEventListener('DOMContentLoaded', async function() {
            loadUserInfo();
            
            // 检查URL是否已有group_id参数
            const urlParams = new URLSearchParams(window.location.search);
            const groupId = urlParams.get('group_id');
            
            // 如果没有指定group_id，自动选择第一个关键词组
            if (!groupId) {
                try {
                    const response = await fetch('/api/user/keyword-groups?include_inactive=false');
                    const data = await response.json();
                    
                    if (data.success && data.groups && data.groups.length > 0) {
                        // 获取第一个激活的组
                        const firstGroup = data.groups.find(g => g.is_active !== false) || data.groups[0];
                        if (firstGroup) {
                            // 更新URL但不刷新页面
                            const newUrl = new URL(window.location);
                            newUrl.searchParams.set('group_id', firstGroup.id);
                            window.history.replaceState({}, '', newUrl);
                        }
                    }
                } catch (error) {
                    console.error('Failed to load keyword groups:', error);
                }
            }
            
            loadPapers(true);
            setupFilterListeners();
            loadLastUpdateInfo();
            
            // 设置滚动加载
            setupScrollLoading();

            // 页面加载时检查是否有正在进行的更新
            checkOngoingUpdate();
        });
        
        // 滚动加载设置
        function setupScrollLoading() {
            let scrollTimeout;
            window.addEventListener('scroll', () => {
                if (scrollTimeout) clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    if (isLoading || !hasMore) return;
                    
                    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    const windowHeight = window.innerHeight;
                    const docHeight = document.documentElement.scrollHeight;
                    
                    // 距离底部200px时触发加载
                    if (scrollTop + windowHeight >= docHeight - 200) {
                        loadMorePapers();
                    }
                }, 100);
            });
        }
        
        // 加载更多文献
        async function loadMorePapers() {
            if (isLoading || !hasMore) return;
            
            isLoading = true;
            showLoadingMore(true);
            
            currentPage++;
            await loadPapers(false);
            
            isLoading = false;
            showLoadingMore(false);
        }
        
        // 显示/隐藏加载更多指示器
        function showLoadingMore(show) {
            let loader = document.getElementById('loading-more');
            if (show) {
                if (!loader) {
                    loader = document.createElement('div');
                    loader.id = 'loading-more';
                    loader.className = 'loading-more';
                    loader.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 正在加载更多文献...';
                    document.getElementById('papers-list').appendChild(loader);
                }
                loader.style.display = 'flex';
            } else if (loader) {
                loader.style.display = 'none';
            }
        }

        // 加载最后更新信息
        async function loadLastUpdateInfo() {
            try {
                const response = await fetch('/api/user/last-update-info');
                const data = await response.json();

                if (data.success) {
                    const lastUpdateEl = document.getElementById('last-update-time');
                    if (lastUpdateEl) {
                        if (data.last_update_at) {
                            lastUpdateEl.textContent = formatTimeAgo(data.last_update_at);
                            lastUpdateEl.title = '最后更新: ' + new Date(data.last_update_at).toLocaleString('zh-CN');
                        } else {
                            lastUpdateEl.textContent = '从未';
                            lastUpdateEl.title = '尚未进行过更新';
                        }
                    }
                }
            } catch (error) {
                console.error('加载最后更新信息失败:', error);
            }
        }

        // 格式化时间为"多久前"
        function formatTimeAgo(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHour = Math.floor(diffMin / 60);
            const diffDay = Math.floor(diffHour / 24);

            if (diffSec < 60) {
                return '刚刚';
            } else if (diffMin < 60) {
                return diffMin + '分钟前';
            } else if (diffHour < 24) {
                return diffHour + '小时前';
            } else if (diffDay < 30) {
                return diffDay + '天前';
            } else {
                return date.toLocaleDateString('zh-CN');
            }
        }

        // 检查是否有正在进行的更新
        async function checkOngoingUpdate() {
            try {
                const response = await fetch('/api/update-status');
                const data = await response.json();
                
                if (data.success && data.status === 'running') {
                    console.log('检测到正在进行的更新任务');
                    // 开始轮询状态
                    if (!updateStatusInterval) {
                        updateStatusInterval = setInterval(pollUpdateStatus, 3000);
                    }
                    
                    // 立即更新按钮状态
                    const btn = document.querySelector('.update-btn');
                    if (btn) {
                        btn.disabled = true;
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 更新中...';
                    }
                    
                    showToast('检测到正在进行的更新任务，请稍候...', 'info');
                }
            } catch (error) {
                console.error('检查更新状态失败:', error);
            }
        }

        // Sidebar toggle for mobile
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        async function loadUserInfo() {
            try {
                const response = await fetch('/api/user/me');
                const data = await response.json();

                if (data.success) {
                    currentUser = data.user;
                    document.getElementById('username-display').textContent = currentUser.username;
                    
                    // 显示用户头像
                    if (currentUser.avatar && currentUser.avatar.startsWith('emoji:')) {
                        document.getElementById('user-avatar').textContent = currentUser.avatar.replace('emoji:', '');
                    }
                    
                    // 检查是否有 group_id 参数
                    const urlParams = new URLSearchParams(window.location.search);
                    const groupId = urlParams.get('group_id');
                    
                    // 只有在没有指定组的情况下才显示用户默认关键词
                    if (!groupId) {
                        document.getElementById('user-keywords').textContent = (currentUser.keywords || []).length;
                        document.getElementById('user-keywords-list').innerHTML = (currentUser.keywords || []).slice(0, 8).map(kw =>
                            `<span class="keyword-tag">${kw}</span>`
                        ).join('') + ((currentUser.keywords || []).length > 8 ? `<span style="font-size: 0.8rem; color: var(--text-muted);">+${(currentUser.keywords || []).length - 8}</span>` : '');
                    }
                } else if (data.redirect) {
                    window.location.href = data.redirect;
                }
            } catch (error) {
                console.error('Failed to load user info:', error);
            }
        }

        async function loadPapers(reset = true) {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                let groupId = urlParams.get('group_id');

                // 如果没有指定组，自动选择第一个激活的组
                if (!groupId && availableGroups.length > 0) {
                    const activeGroup = availableGroups.find(g => g.is_active !== false);
                    if (activeGroup) {
                        groupId = activeGroup.id;
                        console.log('[loadPapers] 自动选择第一个激活的组:', activeGroup.name);
                        // 更新URL，但不刷新页面
                        const newUrl = new URL(window.location);
                        newUrl.searchParams.set('group_id', groupId);
                        window.history.replaceState({}, '', newUrl);
                    }
                }

                // 构建分页URL
                let apiUrl = `/api/papers/personalized?page=${currentPage}&per_page=${PER_PAGE}`;
                if (groupId) {
                    apiUrl += `&group_id=${groupId}`;
                }

                // 重置模式：清空数据
                if (reset) {
                    currentPage = 1;
                    allPapers = [];
                    filteredPapers = [];
                    totalPapers = 0;
                    hasMore = true;
                }

                const papersResponse = await fetch(apiUrl);
                const data = await papersResponse.json();

                if (data.success) {
                    const newPapers = data.papers || [];
                    
                    // 更新分页信息
                    totalPapers = data.total || 0;
                    if (data.pagination) {
                        totalPages = data.pagination.total_pages || 1;
                        hasMore = data.pagination.has_next || false;
                    } else {
                        hasMore = newPapers.length === PER_PAGE;
                    }
                    
                    // 首次加载时初始化收藏管理器
                    if (reset) {
                        const currentGroupSaved = data.saved_papers || [];
                        const globalSaved = data.global_saved_papers || [];
                        favoriteManager.initialize(globalSaved, currentGroupSaved);
                        
                        console.log('[loadPapers] 收藏状态初始化:', {
                            totalPapers: totalPapers,
                            globalSaved: favoriteManager.getGlobalCount(),
                            currentGroupSaved: favoriteManager.getCurrentGroupCount()
                        });
                    }
                    
                    // 为新文献标记收藏状态
                    const papersWithStatus = newPapers.map(paper => ({
                        ...paper,
                        is_saved: favoriteManager.isSavedGlobally(paper.hash)
                    }));
                    
                    // 追加或替换文献
                    if (reset) {
                        allPapers = papersWithStatus;
                    } else {
                        allPapers = [...allPapers, ...papersWithStatus];
                    }
                    filteredPapers = [...allPapers];
                    
                    // 设置当前组
                    if (data.group && data.group.id) {
                        currentGroup = data.group;
                        document.title = `${data.group.name} - OnTarget文献推送系统`;
                        updateGroupDisplay(data.group);
                    } else if (reset) {
                        currentGroup = null;
                        if (totalPapers === 0) {
                            const container = document.getElementById('papers-list');
                            container.innerHTML = `
                                <div class="empty-state">
                                    <i class="fas fa-tags"></i>
                                    <p>还没有关键词组</p>
                                    <p style="margin-top: 0.5rem; font-size: 0.875rem;">请先创建关键词组来获取个性化文献</p>
                                    <a href="/keywords" class="btn btn-primary" style="margin-top: 1rem; text-decoration: none;">
                                        <i class="fas fa-plus"></i> 创建关键词组
                                    </a>
                                </div>
                            `;
                            return;
                        }
                    }

                    renderPapers(reset);
                    await updateStats();

                    // 检测URL参数，自动应用筛选（仅首次）
                    if (reset) {
                        const filterParam = urlParams.get('filter');
                        if (filterParam === 'saved') {
                            const savedOption = document.querySelector('#saved-status-filter .filter-option[data-value="saved"]');
                            if (savedOption) {
                                toggleSavedStatus(savedOption);
                            }
                        }
                    }
                } else {
                    showError('加载失败: ' + data.error);
                }
            } catch (error) {
                showError('加载失败: ' + error.message);
                console.error('[loadPapers] 错误:', error);
            }
        }

        async function loadGlobalSavedCount() {
            try {
                const response = await fetch('/api/user/keyword-groups/summary');
                const data = await response.json();

                if (data.success && data.summary) {
                    // 使用数据库统计的总收藏数
                    const totalSaved = data.summary.total_papers_saved || 0;
                    document.getElementById('user-saved').textContent = totalSaved;
                    console.log('已收藏计数更新:', totalSaved);
                } else {
                    console.error('获取收藏统计失败:', data.error || '未知错误');
                    document.getElementById('user-saved').textContent = '0';
                }
            } catch (error) {
                console.error('加载收藏统计异常:', error);
                document.getElementById('user-saved').textContent = '0';
            }
        }

        async function updateStats() {
            // 更新匹配文献计数（使用总数，而不是已加载数）
            document.getElementById('matched-papers').textContent = totalPapers;
            
            // 使用收藏管理器的计数（实时准确）
            const savedCount = favoriteManager.getGlobalCount();
            document.getElementById('user-saved').textContent = savedCount;
            
            // 加载系统统计（已浏览、系统总文献数等）
            await loadSystemStats();
            
            console.log('[updateStats] 统计更新:', {
                total: totalPapers,
                loaded: allPapers.length,
                saved: savedCount
            });
        }

        async function loadSystemStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();

                if (data.success) {
                    if (data.user) {
                        document.getElementById('user-viewed').textContent = data.user.total_seen || 0;
                        // 不再覆盖 user-saved，让 updateStats() 计算当前视图的收藏数
                    }
                    // 系统文献：所有用户获取过的总文献数
                    if (data.total_papers !== undefined) {
                        document.getElementById('system-papers').textContent = data.total_papers || 0;
                    } else if (data.cache) {
                        document.getElementById('system-papers').textContent = data.cache.cached_papers || 0;
                    }
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // 渲染关键词匹配
        function renderKeywordMatches(matches) {
            let tags = [];
            
            if (matches.core) {
                matches.core.forEach(m => tags.push(m.keyword));
            }
            if (matches.important) {
                matches.important.forEach(m => tags.push(m.keyword));
            }
            if (matches.related) {
                matches.related.forEach(m => tags.push(m.keyword));
            }
            
            if (tags.length === 0) return '';
            
            return `
                <div class="keyword-matches">
                    ${tags.slice(0, 8).map(tag => `<span class="keyword-tag">${tag}</span>`).join('')}
                </div>
            `;
        }

        function renderPapers(reset = true) {
            const container = document.getElementById('papers-list');
            // 显示总数而不是已加载数
            document.getElementById('papers-count').textContent = totalPapers;

            if (filteredPapers.length === 0 && reset) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>没有找到符合条件的文献</p>
                        <p style="margin-top: 0.5rem; font-size: 0.875rem;">请尝试调整关键词或评分阈值</p>
                        <a href="/keywords" class="btn btn-primary" style="margin-top: 1rem; text-decoration: none;">
                            <i class="fas fa-tags"></i> 编辑关键词
                        </a>
                    </div>
                `;
                return;
            }

            if (reset) {
                // 首次加载：替换全部内容
                container.innerHTML = filteredPapers.map(paper => createPaperCard(paper)).join('');
            } else {
                // 加载更多：追加新内容
                const newPapers = filteredPapers.slice(-PER_PAGE);
                const fragment = document.createDocumentFragment();
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = newPapers.map(paper => createPaperCard(paper)).join('');
                while (tempDiv.firstChild) {
                    fragment.appendChild(tempDiv.firstChild);
                }
                // 移除旧的加载指示器
                const oldLoader = document.getElementById('loading-more');
                if (oldLoader) oldLoader.remove();
                container.appendChild(fragment);
            }
            
            // 如果还有更多，添加加载更多区域
            if (hasMore) {
                let loadMoreDiv = document.getElementById('load-more-trigger');
                if (!loadMoreDiv) {
                    loadMoreDiv = document.createElement('div');
                    loadMoreDiv.id = 'load-more-trigger';
                    loadMoreDiv.className = 'load-more-trigger';
                    loadMoreDiv.innerHTML = `<span>已加载 ${allPapers.length} 篇，共 ${totalPapers} 篇</span>`;
                    container.appendChild(loadMoreDiv);
                } else {
                    loadMoreDiv.innerHTML = `<span>已加载 ${allPapers.length} 篇，共 ${totalPapers} 篇</span>`;
                }
            } else {
                const loadMoreDiv = document.getElementById('load-more-trigger');
                if (loadMoreDiv) loadMoreDiv.remove();
                // 显示已全部加载
                if (totalPapers > 0) {
                    const allLoadedDiv = document.createElement('div');
                    allLoadedDiv.className = 'all-loaded';
                    allLoadedDiv.innerHTML = `<i class="fas fa-check-circle"></i> 已全部加载 (${totalPapers} 篇)`;
                    container.appendChild(allLoadedDiv);
                }
            }
        }

        function createPaperCard(paper) {
            const typeBadge = paper.paper_type === 'review'
                ? '<span class="badge badge-review">Review</span>'
                : '<span class="badge badge-research">Research</span>';

            const ifBadge = paper.impact_factor
                ? `<span class="badge badge-if">IF: ${paper.impact_factor.toFixed(1)}</span>`
                : '';

            const scoreBadge = paper.personalized_score !== undefined
                ? `<span class="badge badge-score">${paper.personalized_score.toFixed(0)}分</span>`
                : '';

            const isGloballySaved = favoriteManager.isSavedGlobally(paper.hash);
            const isSavedInCurrentGroup = favoriteManager.isSavedInCurrentGroup(paper.hash);
            const savedBadge = isGloballySaved
                ? '<span class="badge badge-saved"><i class="fas fa-bookmark"></i> 已收藏</span>'
                : '';

            const pubDate = paper.publication_date
                ? new Date(paper.publication_date).toLocaleDateString('zh-CN')
                : '未知';

            const sourceIcon = {
                'pubmed': '<i class="fas fa-database"></i>',
                'biorxiv': '<i class="fas fa-flask"></i>',
                'medrxiv': '<i class="fas fa-user-md"></i>'
            }[paper.source] || '<i class="fas fa-file-alt"></i>';
            
            return `
                <article class="paper-card ${isGloballySaved ? 'saved' : ''}">
                    <div class="paper-header">
                        <h2 class="paper-title">${paper.title || '无标题'}</h2>
                        <div class="paper-badges">
                            ${typeBadge}
                            ${scoreBadge}
                            ${ifBadge}
                            ${savedBadge}
                        </div>
                    </div>

                    <div class="paper-meta">
                        <span>${sourceIcon} ${paper.authors || '未知作者'}</span>
                        <span><i class="fas fa-book"></i> ${paper.journal || '未知期刊'}</span>
                        <span><i class="fas fa-calendar"></i> ${pubDate}</span>
                        <span><i class="fas fa-server"></i> ${paper.source || '未知'}</span>
                    </div>

                    ${paper.keyword_matches ? renderKeywordMatches(paper.keyword_matches) : ''}

                    <div class="paper-abstract">
                        <strong>摘要:</strong> ${paper.abstract || '暂无摘要'}
                    </div>

                    ${paper.abstract_cn ? `
                    <div class="paper-abstract-cn">
                        <div class="paper-abstract-cn-label">
                            <i class="fas fa-language"></i> 中文翻译
                        </div>
                        ${paper.abstract_cn}
                    </div>
                    ` : ''}

                    ${paper.is_analyzed ? `
                    <div class="analysis-grid">
                        <div class="analysis-section">
                            <div class="analysis-title"><i class="fas fa-lightbulb"></i> 主要发现</div>
                            <div class="analysis-content">${paper.main_findings || '暂无'}</div>
                        </div>
                        <div class="analysis-section">
                            <div class="analysis-title"><i class="fas fa-star"></i> 创新点</div>
                            <div class="analysis-content">${paper.innovations || '暂无'}</div>
                        </div>
                        <div class="analysis-section">
                            <div class="analysis-title"><i class="fas fa-exclamation-triangle"></i> 局限性</div>
                            <div class="analysis-content">${paper.limitations || '暂无'}</div>
                        </div>
                        <div class="analysis-section">
                            <div class="analysis-title"><i class="fas fa-compass"></i> 未来方向</div>
                            <div class="analysis-content">${paper.future_directions || '暂无'}</div>
                        </div>
                    </div>
                    ` : `
                    <div class="analysis-section" style="grid-column: 1 / -1; margin-top: var(--spacing-md);">
                        <div class="analysis-content" style="color: var(--text-muted); text-align: center; padding: 2rem;">
                            <i class="fas fa-robot" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                            等待AI分析...
                        </div>
                    </div>
                    `}

                    <div class="paper-actions">
                        ${paper.url ? `<a href="${paper.url}" target="_blank" class="paper-link"><i class="fas fa-external-link-alt"></i> 查看原文</a>` : ''}
                        ${!paper.is_analyzed ? `<button class="btn-analyze" onclick="analyzeSinglePaper('${paper.hash}', this)">
                            <i class="fas fa-brain"></i> AI分析
                        </button>` : ''}
                        ${currentGroup && currentGroup.id ? `
                        <button class="btn-save ${isSavedInCurrentGroup ? 'saved' : ''}" onclick="toggleSave('${paper.hash}')">
                            <i class="${isSavedInCurrentGroup ? 'fas' : 'far'} fa-bookmark"></i>
                            ${isSavedInCurrentGroup ? '已收藏' : '收藏'}
                        </button>
                        ` : `
                        <span style="font-size: 0.875rem; color: var(--text-muted); padding: 0.5rem;">
                            请选择关键词组
                        </span>
                        `}
                    </div>
                </article>
            `;
        }

        function setupFilterListeners() {
            // 其他事件监听器初始化
        }

        // 切换收藏状态筛选
        async function toggleSavedStatus(element) {
            // 使用更可靠的选择器：找到当前元素的父容器（filter-options）下的所有选项
            const parentContainer = element.closest('.filter-options');
            if (parentContainer) {
                parentContainer.querySelectorAll('.filter-option').forEach(opt => {
                    opt.classList.remove('active');
                });
            }
            element.classList.add('active');
            const savedStatus = element.dataset.value;
            console.log('切换收藏筛选为:', savedStatus);
            
            // 如果切换到"仅收藏"，需要加载所有收藏的文献
            if (savedStatus === 'saved') {
                await loadAllSavedPapers();
            }
            
            applyFilters();
        }
        
        // 加载所有收藏的文献（用于"仅收藏"筛选）
        async function loadAllSavedPapers() {
            try {
                console.log('[loadAllSavedPapers] 正在加载所有收藏的文献...');
                showToast('正在加载收藏的文献...', 'info');
                
                const response = await fetch('/api/user/all-saved-papers');
                const data = await response.json();
                
                if (data.success) {
                    console.log('[loadAllSavedPapers] API 返回:', data);
                    
                    // 使用 saved_hashes 更新收藏管理器的全局收藏状态
                    if (data.saved_hashes && data.saved_hashes.length > 0) {
                        favoriteManager.globalSavedHashes = new Set(data.saved_hashes);
                        console.log('[loadAllSavedPapers] 更新全局收藏状态:', data.saved_hashes.length, '篇');
                    }
                    
                    // 合并有详细数据的文献到 allPapers
                    if (data.papers && data.papers.length > 0) {
                        const existingHashes = new Set(allPapers.map(p => p.hash));
                        const newPapers = data.papers.filter(p => !existingHashes.has(p.hash));
                        
                        if (newPapers.length > 0) {
                            // 标记这些文献为已收藏
                            newPapers.forEach(paper => {
                                paper.is_saved = true;
                            });
                            
                            // 合并到 allPapers
                            allPapers = [...allPapers, ...newPapers];
                            console.log('[loadAllSavedPapers] 新增', newPapers.length, '篇文献到列表');
                        }
                        
                        showToast(`已加载 ${data.total} 篇收藏的文献`, 'success');
                    } else {
                        showToast(`找到 ${data.total || 0} 篇收藏的文献（部分可能暂无详细信息）`, 'info');
                    }
                } else {
                    console.log('[loadAllSavedPapers] 加载失败:', data.error);
                    showToast('加载收藏的文献失败', 'error');
                }
            } catch (error) {
                console.error('[loadAllSavedPapers] 加载失败:', error);
                showToast('加载收藏的文献失败', 'error');
            }
        }

        // 切换文献类型
        let currentPaperType = '';
        
        function togglePaperType(element) {
            const clickedValue = element.getAttribute('data-value');
            
            // 如果点击的是当前已选中的，则取消选择（显示全部）
            if (currentPaperType === clickedValue) {
                currentPaperType = '';
            } else {
                currentPaperType = clickedValue;
            }
            
            // 更新所有选项的显示状态
            document.querySelectorAll('#paper-type-filter .filter-option').forEach(opt => {
                if (opt.getAttribute('data-value') === currentPaperType && currentPaperType !== '') {
                    opt.classList.add('active');
                } else {
                    opt.classList.remove('active');
                }
            });
            
            applyFilters();
        }

        function applyFilters() {
            // 获取收藏状态 - 通过 ID 准确定位收藏状态筛选组
            const savedFilterGroup = document.getElementById('saved-status-filter');
            let savedStatus = 'all';
            if (savedFilterGroup) {
                const activeOption = savedFilterGroup.querySelector('.filter-option.active');
                savedStatus = activeOption ? activeOption.dataset.value : 'all';
            }
            
            console.log('[applyFilters] 收藏状态:', savedStatus, '全局收藏数:', favoriteManager.getGlobalCount());
            
            const paperType = currentPaperType;
            const minScore = parseFloat(document.getElementById('min-score').value);

            filteredPapers = allPapers.filter(paper => {
                // 使用收藏管理器判断文献是否被收藏
                if (savedStatus === 'saved') {
                    const isSaved = favoriteManager.isSavedGlobally(paper.hash);
                    if (!isSaved) return false;
                }
                if (minScore > 0 && (paper.personalized_score || 0) < minScore) return false;
                if (paperType && paper.paper_type !== paperType) return false;
                return true;
            });

            console.log('[applyFilters] 筛选完成，结果数量:', filteredPapers.length);
            sortPapers();
        }

        function updateScoreValue(value) {
            document.getElementById('score-display').textContent = parseInt(value) + '-100分';
            applyFilters();
        }

        function sortPapers() {
            const sortType = document.getElementById('sort-select').value;

            filteredPapers.sort((a, b) => {
                if (sortType === 'personalized') {
                    return (b.personalized_score || 0) - (a.personalized_score || 0);
                } else if (sortType === 'date') {
                    return new Date(b.publication_date || 0) - new Date(a.publication_date || 0);
                } else if (sortType === 'if') {
                    return (b.impact_factor || 0) - (a.impact_factor || 0);
                }
                return 0;
            });

            renderPapers();
        }

        async function toggleSave(paperHash) {
            // 使用收藏管理器的锁机制防止重复点击
            if (!favoriteManager.lock(paperHash)) {
                showToast('正在处理中，请稍候...', 'info');
                return;
            }
            
            try {
                // 检查是否有当前组
                if (!currentGroup || !currentGroup.id) {
                    showToast('请先选择一个关键词组', 'error');
                    return;
                }
                
                // 从 allPapers 中查找当前文献
                const paper = allPapers.find(p => p.hash === paperHash);
                if (!paper) {
                    showToast('文献不存在', 'error');
                    return;
                }
                
                // 判断当前组是否已收藏
                const isSaved = favoriteManager.isSavedInCurrentGroup(paperHash);
                const url = isSaved ? '/api/papers/unsave' : '/api/papers/save';

                const requestBody = { 
                    paper_hash: paperHash,
                    group_id: currentGroup.id 
                };

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (data.success) {
                    // 更新收藏管理器状态
                    if (isSaved) {
                        favoriteManager.removeFavorite(paperHash, currentGroup.id);
                        showToast('已取消收藏', 'info');
                    } else {
                        favoriteManager.addFavorite(paperHash, currentGroup.id);
                        showToast('收藏成功', 'success');
                    }

                    // 更新文献列表中的收藏状态
                    allPapers = allPapers.map(p => {
                        if (p.hash === paperHash) {
                            return { ...p, is_saved: favoriteManager.isSavedGlobally(paperHash) };
                        }
                        return p;
                    });
                    
                    filteredPapers = filteredPapers.map(p => {
                        if (p.hash === paperHash) {
                            return { ...p, is_saved: favoriteManager.isSavedGlobally(paperHash) };
                        }
                        return p;
                    });

                    // 立即更新统计信息
                    console.log('[toggleSave] 更新统计:', {
                        saved: favoriteManager.getGlobalCount(),
                        currentGroup: favoriteManager.getCurrentGroupCount()
                    });
                    
                    // 更新收藏计数显示
                    document.getElementById('user-saved').textContent = favoriteManager.getGlobalCount();
                    
                    // 重新渲染（这会更新收藏按钮状态）
                    renderPapers();
                    
                    // 如果当前是"仅收藏"筛选模式，需要重新筛选
                    const savedFilterGroup = document.getElementById('saved-status-filter');
                    if (savedFilterGroup) {
                        const activeOption = savedFilterGroup.querySelector('.filter-option.active');
                        if (activeOption && activeOption.dataset.value === 'saved') {
                            applyFilters();
                        }
                    }
                } else {
                    showToast('操作失败: ' + data.error, 'error');
                }
            } catch (error) {
                showToast('操作失败: ' + error.message, 'error');
                console.error('[toggleSave] 错误:', error);
            } finally {
                // 无论成功或失败，都解锁
                favoriteManager.unlock(paperHash);
            }
        }
        
        // 显示文献收藏组信息
        async function showPaperSavedGroups(paperHash) {
            try {
                const response = await fetch(`/api/papers/${paperHash}/saved-groups`);
                const data = await response.json();
                
                if (data.success && data.count > 0) {
                    const groupNames = data.saved_groups.map(g => g.name).join('、');
                    showToast(`该文献已收藏到 ${data.count} 个组: ${groupNames}`, 'success');
                }
            } catch (error) {
                console.error('Failed to load saved groups:', error);
            }
        }

        // 轮询更新状态
        let updateStatusInterval = null;
        
        async function pollUpdateStatus() {
            try {
                const response = await fetch('/api/update-status');
                const data = await response.json();
                
                if (!data.success) {
                    console.error('获取更新状态失败:', data.error);
                    return;
                }
                
                const status = data.status;
                const btn = document.querySelector('.update-btn');
                
                if (status === 'running') {
                    // 更新按钮状态
                    if (btn) {
                        btn.disabled = true;
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 更新中...';
                    }
                } else if (status === 'completed') {
                    // 更新完成
                    clearInterval(updateStatusInterval);
                    updateStatusInterval = null;
                    
                    const result = data.result || {};
                    const fetched = result.fetched || 0;
                    const fromCache = result.from_cache || 0;
                    const newAnalysis = result.new_analysis || 0;
                    const cachedAnalysis = result.cached_analysis || 0;
                    const total = fromCache + fetched;
                    
                    let message = `✅ 更新完成！获取文献: ${total} 篇`;
                    if (newAnalysis > 0) {
                        message += ` | 🤖 AI分析: ${newAnalysis} 篇`;
                    }
                    if (cachedAnalysis > 0) {
                        message += ` (缓存: ${cachedAnalysis} 篇)`;
                    }
                    showToast(message, 'success');
                    
                    // 刷新文献列表（重置分页）
                    currentPage = 1;
                    hasMore = true;
                    await loadPapers(true);
                    
                    // 恢复按钮
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-sync-alt"></i> <span>更新文献</span>';
                    }
                } else if (status === 'failed') {
                    // 更新失败
                    clearInterval(updateStatusInterval);
                    updateStatusInterval = null;
                    
                    showToast('❌ 更新失败: ' + (data.error || '未知错误'), 'error');
                    
                    // 恢复按钮
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-sync-alt"></i> <span>更新文献</span>';
                    }
                } else if (status === 'idle') {
                    // 没有正在进行的任务
                    clearInterval(updateStatusInterval);
                    updateStatusInterval = null;
                    
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-sync-alt"></i> <span>更新文献</span>';
                    }
                }
            } catch (error) {
                console.error('轮询更新状态失败:', error);
            }
        }
        
        async function triggerUpdate() {
            const btn = document.querySelector('.update-btn');
            
            // 先检查当前状态
            try {
                const statusResponse = await fetch('/api/update-status');
                const statusData = await statusResponse.json();
                
                if (statusData.success && statusData.status === 'running') {
                    showToast('更新正在进行中，请稍候...', 'info');
                    // 开始轮询
                    if (!updateStatusInterval) {
                        updateStatusInterval = setInterval(pollUpdateStatus, 3000);
                    }
                    return;
                }
            } catch (e) {
                console.error('检查状态失败:', e);
            }
            
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 启动中...';
            }
            showToast('正在启动更新任务...', 'info');

            try {
                const response = await fetch('/api/trigger-update', { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    showToast('✅ ' + data.message, 'success');
                    
                    // 开始轮询状态
                    if (!updateStatusInterval) {
                        updateStatusInterval = setInterval(pollUpdateStatus, 3000); // 每3秒查询一次
                    }
                    
                    // 立即查询一次
                    pollUpdateStatus();
                    
                } else {
                    if (data.redirect) {
                        showToast('请先登录', 'error');
                        setTimeout(() => {
                            window.location.href = data.redirect;
                        }, 1000);
                    } else {
                        showToast('❌ ' + data.error, 'error');
                        if (btn) {
                            btn.disabled = false;
                            btn.innerHTML = '<i class="fas fa-sync-alt"></i> <span>更新文献</span>';
                        }
                    }
                }
            } catch (error) {
                console.error('Update error:', error);
                showToast('❌ 启动更新失败: ' + error.message, 'error');
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-sync-alt"></i> <span>更新文献</span>';
                }
            }
        }

        async function analyzePending() {
            const btn = document.querySelector('.analyze-btn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 分析中...';
            }
            showToast('正在分析文献，请稍候...', 'info');

            try {
                const response = await fetch('/api/analyze-pending', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();

                if (data.success) {
                    const count = data.analyzed_count || 0;
                    if (count > 0) {
                        showToast(`✅ 分析完成！共分析了 ${count} 篇文献`, 'success');
                    } else {
                        showToast('📊 所有文献已完成分析，无需重复分析', 'info');
                    }
                    await loadPapers();
                } else {
                    if (data.redirect) {
                        showToast('请先登录', 'error');
                        setTimeout(() => {
                            window.location.href = data.redirect;
                        }, 1000);
                    } else {
                        showToast('❌ 分析失败: ' + data.error, 'error');
                    }
                }
            } catch (error) {
                console.error('Analysis error:', error);
                showToast('❌ 分析失败: ' + error.message, 'error');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-brain"></i> <span>全部分析</span>';
                }
            }
        }

        async function analyzeSinglePaper(paperHash, btn) {
            if (!btn) return;
            const card = btn.closest('.paper-card');
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 分析中...';

            try {
                const response = await fetch('/api/analyze-paper', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ paper_hash: paperHash, async: false })
                });
                const data = await response.json();

                if (data.success && data.analysis) {
                    showToast('✅ AI分析完成！', 'success');
                    
                    // 直接更新当前卡片，不重新加载页面
                    updatePaperCard(card, paperHash, data.analysis);
                } else if (data.async && data.task_id) {
                    // 异步模式：轮询等待结果
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 分析中...';
                    await pollAnalysisResult(data.task_id, card, paperHash, btn, originalContent);
                } else {
                    showToast('❌ 分析失败: ' + (data.error || '未知错误'), 'error');
                    btn.disabled = false;
                    btn.innerHTML = originalContent;
                }
            } catch (error) {
                console.error('Single analysis error:', error);
                showToast('❌ 分析失败: ' + error.message, 'error');
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        }
        
        function updatePaperCard(card, paperHash, analysis) {
            if (!card || !analysis) return;
            
            // 更新内存中的数据
            const paperIndex = allPapers.findIndex(p => p.hash === paperHash);
            if (paperIndex !== -1) {
                allPapers[paperIndex] = { ...allPapers[paperIndex], ...analysis, is_analyzed: true };
                const filteredIndex = filteredPapers.findIndex(p => p.hash === paperHash);
                if (filteredIndex !== -1) {
                    filteredPapers[filteredIndex] = { ...filteredPapers[filteredIndex], ...analysis, is_analyzed: true };
                }
            }
            
            // 查找或创建分析结果区域
            let analysisGrid = card.querySelector('.analysis-grid');
            const paper = allPapers.find(p => p.hash === paperHash) || {};
            
            if (!analysisGrid) {
                // 创建分析结果区域
                const actionsDiv = card.querySelector('.paper-actions');
                analysisGrid = document.createElement('div');
                analysisGrid.className = 'analysis-grid';
                actionsDiv.parentNode.insertBefore(analysisGrid, actionsDiv);
            }
            
            // 更新分析内容
            analysisGrid.innerHTML = `
                <div class="analysis-section">
                    <div class="analysis-title"><i class="fas fa-lightbulb"></i> 主要发现</div>
                    <div class="analysis-content">${escapeHtml(analysis.main_findings) || '暂无'}</div>
                </div>
                <div class="analysis-section">
                    <div class="analysis-title"><i class="fas fa-star"></i> 创新点</div>
                    <div class="analysis-content">${escapeHtml(analysis.innovations) || '暂无'}</div>
                </div>
                <div class="analysis-section">
                    <div class="analysis-title"><i class="fas fa-exclamation-triangle"></i> 局限性</div>
                    <div class="analysis-content">${escapeHtml(analysis.limitations) || '暂无'}</div>
                </div>
                <div class="analysis-section">
                    <div class="analysis-title"><i class="fas fa-compass"></i> 未来方向</div>
                    <div class="analysis-content">${escapeHtml(analysis.future_directions) || '暂无'}</div>
                </div>
            `;
            
            // 如果有中文翻译，更新
            if (analysis.abstract_cn) {
                let cnDiv = card.querySelector('.paper-abstract-cn');
                if (!cnDiv) {
                    const abstractDiv = card.querySelector('.paper-abstract');
                    cnDiv = document.createElement('div');
                    cnDiv.className = 'paper-abstract-cn';
                    abstractDiv.parentNode.insertBefore(cnDiv, abstractDiv.nextSibling);
                }
                cnDiv.innerHTML = `
                    <div class="paper-abstract-cn-label">
                        <i class="fas fa-language"></i> 中文翻译
                    </div>
                    ${escapeHtml(analysis.abstract_cn)}
                `;
            }
            
            // 移除"等待AI分析"提示
            const waitingDiv = card.querySelector('.analysis-section[style*="grid-column"]');
            if (waitingDiv) waitingDiv.remove();
            
            // 移除分析按钮
            const analyzeBtn = card.querySelector('.btn-analyze');
            if (analyzeBtn) analyzeBtn.remove();
        }
        
        async function pollAnalysisResult(taskId, card, paperHash, btn, originalContent) {
            const maxAttempts = 60; // 最多等待2分钟
            let attempts = 0;
            
            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(`/api/analyze-status/${taskId}`);
                    const data = await response.json();
                    
                    if (data.status === 'completed' && data.result) {
                        showToast('✅ AI分析完成！', 'success');
                        updatePaperCard(card, paperHash, data.result);
                        btn.remove();
                        return;
                    } else if (data.status === 'failed') {
                        showToast('❌ 分析失败: ' + (data.error || '未知错误'), 'error');
                        btn.disabled = false;
                        btn.innerHTML = originalContent;
                        return;
                    }
                    
                    // 等待2秒后重试
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    attempts++;
                } catch (error) {
                    console.error('Poll error:', error);
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    attempts++;
                }
            }
            
            // 超时
            showToast('⚠️ 分析超时，请稍后刷新查看', 'warning');
            btn.disabled = false;
            btn.innerHTML = originalContent;
        }

        // 用户下拉菜单（桌面端）
        function toggleUserDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('user-dropdown');
            dropdown.classList.toggle('show');
        }

        // 点击其他地方关闭下拉菜单
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('user-dropdown');
            const userInfo = document.getElementById('user-info');
            if (dropdown && userInfo && !userInfo.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // 移动端用户菜单
        function toggleMobileUserMenu() {
            document.getElementById('mobile-user-overlay').classList.add('active');
            document.getElementById('mobile-user-menu').classList.add('active');
            // 更新移动端用户名和头像
            const avatar = document.getElementById('user-avatar').textContent;
            const username = document.getElementById('username-display').textContent;
            document.getElementById('mobile-user-avatar').textContent = avatar;
            document.getElementById('mobile-username').textContent = username;
        }

        function closeMobileUserMenu() {
            document.getElementById('mobile-user-overlay').classList.remove('active');
            document.getElementById('mobile-user-menu').classList.remove('active');
        }

        // 打开用户设置（在当前页面打开设置模态框）
        function openUserSettings(event) {
            if (event) event.stopPropagation();
            // 关闭下拉菜单
            const dropdown = document.getElementById('user-dropdown');
            if (dropdown) dropdown.classList.remove('show');
            // 加载设置并打开模态框
            loadSettings();
            document.getElementById('settings-modal').classList.add('show');
        }

        // 关闭设置模态框
        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.remove('show');
        }

        // 加载设置
        async function loadSettings() {
            try {
                const response = await fetch('/api/user/settings');
                const data = await response.json();

                if (data.success) {
                    const settings = data.settings;
                    document.getElementById('settings-api-provider').value = settings.api_provider || 'deepseek';
                    document.getElementById('settings-api-key').value = '';
                    document.getElementById('settings-update-frequency').value = settings.update_frequency_days || 7;
                    document.getElementById('settings-max-analyze').value = settings.max_auto_analyze || 20;

                    // 加载自动更新设置
                    await loadAutoUpdateSettings();
                }
            } catch (error) {
                console.error('加载设置失败:', error);
            }
        }

        // 加载自动更新设置
        async function loadAutoUpdateSettings() {
            try {
                const response = await fetch('/api/user/auto-update-settings');
                const data = await response.json();

                if (data.success) {
                    const settings = data.settings;
                    const enabled = settings.enabled || false;
                    const intervalDays = settings.interval_days || 2;

                    // 设置开关状态
                    const enabledCheckbox = document.getElementById('settings-auto-update-enabled');
                    enabledCheckbox.checked = enabled;

                    // 设置间隔天数
                    document.getElementById('settings-auto-update-interval').value = intervalDays;

                    // 显示/隐藏间隔设置
                    toggleAutoUpdateInterval(enabled);

                    // 绑定开关事件
                    enabledCheckbox.onchange = function() {
                        toggleAutoUpdateInterval(this.checked);
                    };

                    // 绑定间隔按钮事件
                    document.querySelectorAll('.interval-btn').forEach(btn => {
                        btn.onclick = function() {
                            const days = parseInt(this.dataset.days);
                            document.getElementById('settings-auto-update-interval').value = days;
                            updateIntervalButtons(days);
                        };
                    });

                    // 绑定输入框事件
                    document.getElementById('settings-auto-update-interval').onchange = function() {
                        let days = parseInt(this.value);
                        if (days < 2) days = 2;
                        if (days > 30) days = 30;
                        this.value = days;
                        updateIntervalButtons(days);
                    };

                    // 初始化按钮状态
                    updateIntervalButtons(intervalDays);
                }
            } catch (error) {
                console.error('加载自动更新设置失败:', error);
            }
        }

        // 切换自动更新间隔显示
        function toggleAutoUpdateInterval(show) {
            const group = document.getElementById('auto-update-interval-group');
            if (group) {
                group.style.display = show ? 'block' : 'none';
            }
        }

        // 更新间隔按钮状态
        function updateIntervalButtons(selectedDays) {
            document.querySelectorAll('.interval-btn').forEach(btn => {
                const days = parseInt(btn.dataset.days);
                if (days === selectedDays) {
                    btn.classList.add('btn-primary');
                    btn.classList.remove('btn-secondary');
                } else {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-secondary');
                }
            });
        }

        // 保存设置
        async function saveSettings() {
            const apiProvider = document.getElementById('settings-api-provider').value;
            const apiKey = document.getElementById('settings-api-key').value;
            const updateFrequency = document.getElementById('settings-update-frequency').value;
            const maxAnalyze = document.getElementById('settings-max-analyze').value;

            // 获取选中的文献源
            const sourceCheckboxes = document.querySelectorAll('#sources-checkboxes input[type="checkbox"]');
            const selectedSources = Array.from(sourceCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);

            // 获取自动更新设置
            const autoUpdateEnabled = document.getElementById('settings-auto-update-enabled').checked;
            const autoUpdateInterval = parseInt(document.getElementById('settings-auto-update-interval').value) || 2;

            try {
                // 保存常规设置
                const response = await fetch('/api/user/settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        api_provider: apiProvider,
                        api_key: apiKey,
                        update_frequency_days: parseInt(updateFrequency),
                        max_auto_analyze: parseInt(maxAnalyze),
                        sources: selectedSources
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // 保存自动更新设置
                    const autoUpdateResponse = await fetch('/api/user/auto-update-settings', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            enabled: autoUpdateEnabled,
                            interval_days: Math.max(2, Math.min(30, autoUpdateInterval))
                        })
                    });

                    const autoUpdateData = await autoUpdateResponse.json();

                    if (autoUpdateData.success) {
                        showToast('设置已保存' + (autoUpdateEnabled ? '，自动更新已启用' : ''), 'success');
                        closeSettingsModal();
                    } else {
                        showToast(autoUpdateData.error || '自动更新设置保存失败', 'error');
                    }
                } else {
                    showToast(data.error || '保存失败', 'error');
                }
            } catch (error) {
                console.error('Save settings error:', error);
                showToast('保存失败: ' + error.message, 'error');
            }
        }

        async function goToFirstGroup() {
            try {
                const response = await fetch('/api/user/keyword-groups');
                const data = await response.json();
                
                if (data.success && data.groups && data.groups.length > 0) {
                    // 获取第一个关键词组
                    const firstGroup = data.groups[0];
                    window.location.href = `/?group_id=${firstGroup.id}`;
                } else {
                    // 没有关键词组，跳转到关键词管理页面
                    window.location.href = '/keywords';
                }
            } catch (error) {
                console.error('Error getting first group:', error);
                // 出错时默认跳转到首页
                window.location.href = '/';
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');

            toast.className = 'toast ' + type;
            toastMessage.textContent = message;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function updateGroupDisplay(group) {
            // 更新面板标题
            const panelTitle = document.querySelector('.panel-title');
            if (panelTitle) {
                panelTitle.innerHTML = `${group.icon} ${group.name}`;
            }
            
            // 更新关键词列表
            const keywordsList = document.getElementById('user-keywords-list');
            if (keywordsList && group.keywords) {
                const keywords = group.keywords;
                if (keywords.length > 0) {
                    keywordsList.innerHTML = keywords.slice(0, 10).map(kw =>
                        `<span class="keyword-tag" style="background: ${group.color}20; color: ${group.color}; border: 1px solid ${group.color}40;">${kw}</span>`
                    ).join('') + (keywords.length > 10 ? `<span style="font-size: 0.8rem; color: var(--text-muted);">+${keywords.length - 10}</span>` : '');
                } else {
                    keywordsList.innerHTML = '<span style="color: var(--text-muted);">暂无关键词</span>';
                }
            }
            
            // 更新关键词数量统计
            const keywordsCount = document.getElementById('user-keywords');
            if (keywordsCount && group.keywords) {
                keywordsCount.textContent = group.keywords.length;
            }
        }

        function showError(message) {
            const container = document.getElementById('papers-list');
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-circle" style="color: #e8a8a8;"></i>
                    <p>${message}</p>
                </div>
            `;
        }
    </script>
</body>
</html>
